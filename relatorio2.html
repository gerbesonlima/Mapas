<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" /> 
  <title>Relat√≥rio Mensal - Congrega√ß√£o S√£o Paulo</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary-color: #4f46e5; /* Harmonizado com app - Indigo */
      --primary-hover-color: #6366f1; /* Azul mais claro para hover */
      --danger-color: #dc3545;
      --background-color: #f8fafc; /* Fundo claro harmonizado */
      --card-bg: #fff;
      --text-color: #333;
      --label-color: #444;
      --border: #ced4da;
      --focus-shadow: rgba(79, 70, 229, 0.18); /* Azul indigo */
      --max-width: 680px;
      
      /* Vari√°veis adicionais da app */
      --accent-color: #FFC107; 
      --text-light-color: #ffffff;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; padding: 0; } /* Sem margens para iframe */
    
    /* --- Conte√∫do Principal --- */
    .main-content {
        padding: 16px;
        background: var(--background-color);
        min-height: 100%; /* Preenche o iframe */
    }

    /* Estilos do Formul√°rio (mantidos e harmonizados) */
    .container{
      width: 100%;
      max-width: var(--max-width);
      background: var(--card-bg);
      border-radius: 14px;
      padding: 28px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.08);
      margin: 0 auto; 
    }

    .header { text-align: center; margin-bottom: 20px; }
    .header h1 { margin: 0; color: var(--primary-color); font-size: 1.5rem; }
    .header p { margin: 6px 0 0; color: var(--label-color); font-weight: 500; }

    .form-group { margin-bottom: 16px; }
    label { display:block; margin-bottom:8px; color:var(--label-color); font-weight:600; }
    select, input[type="number"], textarea {
      width:100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 15px;
      font-family: inherit;
      transition: box-shadow .15s, border-color .15s;
    }
    select:focus, input[type="number"]:focus, textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 6px var(--focus-shadow);
    }
    textarea { min-height: 92px; resize: vertical; }

    .radio-group { display:flex; gap:12px; align-items:center; }
    .radio-group label { font-weight:500; cursor:pointer; display:flex; gap:8px; align-items:center; }

    button {
      font-weight:700;
      padding: 12px 16px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-size: 15px;
      font-family: inherit;
    }
    #submit-button {
      width: 100%;
      background: var(--primary-color);
      color: #fff;
    }
    #submit-button:hover:not(:disabled) { background: var(--primary-hover-color); }
    button:disabled { background:#ccc; cursor:not-allowed; }

    #pioneer-details { display:none; background:#f8f9fa; padding:12px; border-radius:8px; margin-top:8px; }

    /* feedback screens */
    .hidden { display:none !important; }
    #success-screen {
      text-align:center; padding:20px; border-radius:12px; background:#e6f4ea; border:1px solid #cce3d6;
    }
    #success-screen h2 { color: #155724; margin:0 0 8px; }
    .button-group { display:flex; gap:12px; justify-content:center; margin-top:12px; flex-wrap:wrap; }
    #new-report-btn { background:var(--primary-color); color:#fff; }
    #exit-btn { background:#b12222; color:#fff; }

    #error-message { color:#721c24; background:#f8d7da; padding:12px; border-radius:8px; border:1px solid #f5c6cb; margin-top:12px; }

    /* loading */
    #loading { display:flex; align-items:center; gap:12px; justify-content:center; padding:16px; color:var(--primary-color); }
    .spinner { width:36px;height:36px;border:4px solid #c8e6c9;border-top-color:var(--primary-color);border-radius:50%;animation:spin 0.9s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }

    /* modal */
    #confirmation-modal {
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      background: rgba(0,0,0,0.55); z-index:9999; visibility:hidden; opacity:0; transition:opacity .2s, visibility .2s;
    }
    #confirmation-modal.show { visibility:visible; opacity:1; }
    .modal-content {
      background:var(--card-bg); padding:18px; border-radius:12px; width: min(520px, 92%); box-shadow:0 8px 30px rgba(0,0,0,0.3);
      transform: translateY(-18px); transition:transform .2s;
    }
    #confirmation-modal.show .modal-content { transform: translateY(0); }
    .modal-buttons { display:flex; gap:12px; justify-content:flex-end; margin-top:16px; }

    /* responsive */
    @media (max-width:520px){
      .container{ padding:18px; }
      .header h1{ font-size:1.25rem; }
    }
  </style>
</head>
<body>
  
  <main class="main-content">
    <div class="container" role="main" aria-labelledby="page-title">
      <div class="header">
        <h1 id="page-title">Relat√≥rio Mensal de Publicadores</h1>
        <p>Congrega√ß√£o S√£o Paulo</p>
      </div>

      <div id="loading" aria-live="polite">
        <div class="spinner" aria-hidden="true"></div>
        <div id="loading-text">Carregando...</div>
      </div>

      <form id="report-form" class="hidden" novalidate>
        <div class="form-group">
          <label for="group-select">1. Selecione o seu Grupo:</label>
          <select id="group-select" name="group" required>
            <option value="">-- Carregando grupos --</option>
          </select>
        </div>
  
        <div class="form-group">
          <label for="name-select">2. Selecione o seu Nome:</label>
          <select id="name-select" name="name" required disabled>
            <option value="">-- Primeiro escolha um grupo --</option>
          </select>
        </div>
  
        <div class="form-group">
          <label for="month-select">3. Selecione o M√™s Trabalhado:</label>
          <select id="month-select" name="month" required></select>
        </div>
  
        <div class="form-group">
          <label for="participated-select">4. Voc√™ participou de alguma modalidade no minist√©rio este m√™s?</label>
          <select id="participated-select" name="participatedInMinistry" required>
            <option value="">-- Selecione --</option>
            <option value="Sim">Sim</option>
            <option value="N√£o">N√£o</option>
          </select>
        </div>
  
        <div class="form-group">
          <label for="study-count">5. Quantos estudos b√≠blicos dirigiu?</label>
          <input type="number" id="study-count" name="studyCount" min="0" placeholder="Digite a quantidade..." required>
        </div>
  
        <div class="form-group">
          <label>6. Voc√™ est√° de Pioneiro?</label>
          <div class="radio-group" role="radiogroup" aria-label="√â Pioneiro?">
            <label><input type="radio" name="isPioneer" value="Sim" required> Sim</label>
            <label><input type="radio" name="isPioneer" value="N√£o" checked> N√£o</label>
          </div>
        </div>
  
        <div id="pioneer-details" class="form-group" aria-hidden="true">
          <label for="pioneer-type">Tipo de Pioneiro:</label>
          <select id="pioneer-type" name="pioneerType">
            <option value="">-- Selecione --</option>
            <option value="Regular">Regular</option>
            <option value="Auxiliar">Auxiliar</option>
          </select>
          <div style="height:10px;"></div>
          <label for="pioneer-hours">Quantas horas fez no m√™s?</label>
          <input type="number" id="pioneer-hours" name="hours" min="0" placeholder="Digite a quantidade...">
        </div>
  
        <div class="form-group">
          <label for="observations">7. Observa√ß√µes (opcional):</label>
          <textarea id="observations" name="observations" placeholder="Observa√ß√µes..."></textarea>
        </div>
  
        <button type="submit" id="submit-button">Enviar Relat√≥rio</button>
      </form>
  
      <div id="success-screen" class="hidden" role="status">
        <h2>Relat√≥rio Enviado!</h2>
        <p>Obrigado por enviar seu relat√≥rio.</p>
        <div class="button-group">
          <button id="new-report-btn">Novo Relat√≥rio</button>
          <button id="exit-btn">Sair</button>
        </div>
      </div>

      <div id="goodbye-screen" class="hidden">
        <h2>Obrigado!</h2>
        <p>Seu relat√≥rio foi recebido com sucesso. Que Jeov√° aben√ßoe seus esfor√ßos.</p>
      </div>
      
      <div id="error-message" class="hidden"></div>
      
      <!-- Modal de Confirma√ß√£o -->
      <div id="confirmation-modal">
        <div class="modal-content">
          <h2>Confirme os Dados</h2>
          <div id="confirmation-details"></div>
          <div class="modal-buttons">
            <button id="edit-button">Editar</button>
            <button id="confirm-send">Enviar</button>
          </div>
        </div>
      </div>
  
    </div>
  </main>

  <script>
    // Seu script original aqui...
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxrh8f4tShxX6i9h4CsQdQd9L4J4S8J5N8w/exec'; // Exemplo, ajuste conforme necess√°rio

    const loadingDiv = document.getElementById('loading');
    const form = document.getElementById('report-form');
    const monthSelect = document.getElementById('month-select');
    const groupSelect = document.getElementById('group-select');
    const nameSelect = document.getElementById('name-select');
    const pioneerDetails = document.getElementById('pioneer-details');
    const pioneerType = document.getElementById('pioneer-type');
    const pioneerHours = document.getElementById('pioneer-hours');
    const isPioneerRadios = document.querySelectorAll('input[name="isPioneer"]');
    const submitButton = document.getElementById('submit-button');
    const successScreen = document.getElementById('success-screen');
    const errorMessage = document.getElementById('error-message');
    const newReportBtn = document.getElementById('new-report-btn');
    const exitBtn = document.getElementById('exit-btn');
    const goodbyeScreen = document.getElementById('goodbye-screen');

    // Modal
    const modal = document.getElementById('confirmation-modal');
    const confirmationDetails = document.getElementById('confirmation-details');
    const confirmSendBtn = document.getElementById('confirm-send');
    const editButton = document.getElementById('edit-button');

    // Estado
    let groupsData = {};            
    let currentFormData = {};       

    const delay = ms => new Promise(res => setTimeout(res, ms));

    document.addEventListener('DOMContentLoaded', () => {
      populateMonthSelect();
      fetchGroups();
      attachListeners();
    });

    function populateMonthSelect(){
      const months = ["Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
      const now = new Date();
      monthSelect.innerHTML = '<option value="">-- Selecione --</option>';
      for (let i = 0; i < 3; i++) {
        const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const label = `${months[d.getMonth()]} de ${d.getFullYear()}`;
        const value = `${months[d.getMonth()]}/${d.getFullYear()}`;
        monthSelect.add(new Option(label, value));
      }
    }

    /* -----------------------------
       FETCH GROUPS (com cache)
       - Tenta sessionStorage primeiro
       - Se falhar, chama o Apps Script
    ------------------------------*/
    async function fetchGroups(){
      try {
        // Tenta carregar cache local primeiro
        const cached = sessionStorage.getItem('groupsData_v1');
        if (cached) {
          groupsData = JSON.parse(cached);
          populateGroups(groupsData);
          loadingDiv.classList.add('hidden');
          form.classList.remove('hidden');
          return;
        }

        // Chamando endpoint
        loadingText.textContent = 'Carregando grupos...';
        const res = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify({ action: 'getGroupNames' })
        });

        if (!res.ok) throw new Error('Resposta do servidor n√£o OK');

        const data = await res.json();

        // Se o script responder {status:'error', message:...}
        if (data && data.status === 'error') {
          throw new Error(data.message || 'Erro ao obter grupos');
        }

        groupsData = data || {};
        sessionStorage.setItem('groupsData_v1', JSON.stringify(groupsData));
        populateGroups(groupsData);

        loadingDiv.classList.add('hidden');
        form.classList.remove('hidden');

      } catch (err) {
        console.error('fetchGroups erro:', err);
        loadingText.textContent = '‚ùå Erro ao carregar grupos. Recarregue a p√°gina.';
      }
    }

    function populateGroups(data){
      groupSelect.innerHTML = '<option value="">-- Selecione --</option>';
      const groups = Object.keys(data).sort((a,b) => a.localeCompare(b, 'pt-BR'));
      groups.forEach(g => groupSelect.add(new Option(g, g)));
    }

    /* -----------------------------
       FETCH NAMES POR GRUPO (lazy load)
       - Tamb√©m atualiza cache local para remover nomes j√° usados
    ------------------------------*/
    async function fetchNamesByGroup(group){
      nameSelect.innerHTML = '<option value="">Carregando nomes...</option>';
      nameSelect.disabled = true;

      try {
        // Se tivermos no cache (groupsData) e o grupo j√° tenha nomes ‚Äî usar cache
        if (groupsData && Array.isArray(groupsData[group]) && groupsData[group].length > 0) {
          populateNames(group, groupsData[group]);
          return;
        }

        const res = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify({ action: 'getNamesByGroup', group })
        });

        if (!res.ok) throw new Error('Erro ao carregar nomes');

        const names = await res.json();
        populateNames(group, Array.isArray(names) ? names : []);
      } catch (err) {
        console.error('fetchNamesByGroup erro:', err);
        nameSelect.innerHTML = '<option value="">Erro ao carregar nomes</option>';
      }
    }

    function populateNames(group, names){
      nameSelect.innerHTML = '<option value="">-- Selecione --</option>';
      const sorted = (names || []).slice().sort((a,b) => a.localeCompare(b, 'pt-BR'));
      sorted.forEach(n => nameSelect.add(new Option(n, n)));
      nameSelect.disabled = false;
    }

    /* -----------------------------
       PIONEER visibility
    ------------------------------*/
    function attachListeners(){
      groupSelect.addEventListener('change', async () => {
        const group = groupSelect.value;
        if (!group) {
          nameSelect.innerHTML = '<option value="">-- Primeiro escolha um grupo --</option>';
          nameSelect.disabled = true;
          return;
        }

        // Lazy load nomes
        await fetchNamesByGroup(group);
      });

      isPioneerRadios.forEach(radio => {
        radio.addEventListener('change', () => {
          const isYes = radio.value === 'Sim' && radio.checked;
          pioneerDetails.style.display = isYes ? 'block' : 'none';
          pioneerType.required = isYes;
          pioneerHours.required = isYes;
          pioneerDetails.setAttribute('aria-hidden', !isYes);
          if (!isYes) { pioneerType.value = ''; pioneerHours.value = ''; }
        });
      });

      form.addEventListener('submit', (e) => {
        e.preventDefault();
        if (!form.checkValidity()) { form.reportValidity(); return; }
        currentFormData = collectFormData();
        showConfirmationModal(currentFormData);
      });

      confirmSendBtn.addEventListener('click', async () => {
        modal.classList.remove('show');
        await sendReport(currentFormData);
      });

      editButton.addEventListener('click', () => {
        modal.classList.remove('show');
      });

      newReportBtn.addEventListener('click', () => {
        successScreen.classList.add('hidden');
        form.classList.remove('hidden');
        submitButton.disabled = false;
        submitButton.textContent = 'Enviar Relat√≥rio';
      });

      exitBtn.addEventListener('click', () => {
        successScreen.classList.add('hidden');
        goodbyeScreen.classList.remove('hidden');
      });
    }

    function collectFormData(){
      const fd = new FormData(form);
      const isP = fd.get('isPioneer');
      return {
        group: fd.get('group'),
        name: fd.get('name'),
        month: fd.get('month'),
        participatedInMinistry: fd.get('participatedInMinistry'),
        studyCount: fd.get('studyCount'),
        isPioneer: isP,
        pioneerType: isP === 'Sim' ? fd.get('pioneerType') : 'N/A',
        hours: isP === 'Sim' ? fd.get('hours') : 'N/A',
        observations: fd.get('observations') ? fd.get('observations').trim() : 'Nenhuma'
      };
    }

    function showConfirmationModal(data){
      let html = `
        <p><strong>Grupo:</strong> ${escapeHtml(data.group)}</p>
        <p><strong>Nome:</strong> ${escapeHtml(data.name)}</p>
        <p><strong>M√™s:</strong> ${escapeHtml(data.month)}</p>
        <p><strong>Participou do minist√©rio:</strong> ${escapeHtml(data.participatedInMinistry)}</p>
        <p><strong>Estudos b√≠blicos:</strong> ${escapeHtml(data.studyCount)}</p>
        <p><strong>√â Pioneiro:</strong> ${escapeHtml(data.isPioneer)}</p>
      `;
      if (data.isPioneer === 'Sim') {
        html += `<p><strong>Tipo:</strong> ${escapeHtml(data.pioneerType)}</p>
                 <p><strong>Horas:</strong> ${escapeHtml(data.hours)}</p>`;
      }
      html += `<p><strong>Observa√ß√µes:</strong> ${escapeHtml(data.observations)}</p>`;
      confirmationDetails.innerHTML = html;
      modal.classList.add('show');
    }

    // Pequena fun√ß√£o de escape para evitar inje√ß√£o de HTML no modal
    function escapeHtml(str = '') {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    /* -----------------------------
       Envio com retry/backoff
       - Atualiza cache local (removendo o nome enviado) para que
         usu√°rios usando a mesma sess√£o n√£o vejam o nome j√° usado
    ------------------------------*/
    async function sendReport(data, attempt = 1){
      try {
        submitButton.disabled = true;
        submitButton.textContent = 'Enviando... üîÑ';
        errorMessage.classList.add('hidden');

        const res = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify({ action: 'saveData', data })
        });

        if (!res.ok) throw new Error('Resposta do servidor n√£o OK');

        const result = await res.json();

        if (!result || result.status !== 'success') {
          const msg = (result && result.message) ? result.message : 'Erro no servidor';
          throw new Error(msg);
        }

        // Remover localmente o nome do cache para que n√£o apare√ßa em novos selects nesta sess√£o
        removeNameFromLocalCache(data.group, data.name);

        // Mostrar sucesso
        form.reset();
        pioneerDetails.style.display = 'none';
        form.classList.add('hidden');
        successScreen.classList.remove('hidden');
        submitButton.disabled = false;
        submitButton.textContent = 'Enviar Relat√≥rio';

      } catch (err) {
        console.warn(`Envio tentativa ${attempt} falhou:`, err);
        if (attempt < 3) {
          // backoff exponencial leve
          await delay(400 * attempt);
          return sendReport(data, attempt + 1);
        }
        errorMessage.textContent = `‚ùå Erro ao enviar: ${err.message || 'Verifique a conex√£o.'}`;
        errorMessage.classList.remove('hidden');
        submitButton.disabled = false;
        submitButton.textContent = 'Enviar Relat√≥rio';
      }
    }

    function removeNameFromLocalCache(group, name){
      try {
        const raw = sessionStorage.getItem('groupsData_v1');
        if (!raw) return;
        const obj = JSON.parse(raw);
        if (!obj[group]) return;
        const idx = obj[group].findIndex(n => n === name);
        if (idx !== -1) {
          obj[group].splice(idx, 1);
          sessionStorage.setItem('groupsData_v1', JSON.stringify(obj));
        }
        // Se o current loaded group is the same, update the select UI
        if (groupSelect.value === group) {
          const optIndex = Array.from(nameSelect.options).findIndex(o => o.value === name);
          if (optIndex > -1) nameSelect.remove(optIndex);
        }
      } catch (e) {
        console.warn('Falha ao atualizar cache local:', e);
      }
    }

    // Utility: limpa cache caso deseje for√ßar reload manual (n√£o usado automaticamente)
    function clearLocalGroupsCache(){
      sessionStorage.removeItem('groupsData_v1');
    }

  </script>
</body>
</html>