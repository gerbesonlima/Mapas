<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resumo das Atividades</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
    <style>
        .week-card { transition: all 0.3s ease; cursor: pointer; }
        .week-card:hover { transform: translateY(-4px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .week-card.active { border: 2px solid #4f46e5; background-color: #eef2ff; }
        .field-day { font-weight: 600; color: #1d4ed8; }
        .cleaning-group { font-weight: 500; color: #7c2d12; }
        .role { display: inline-block; padding: 0.125rem 0.5rem; border-radius: 0.375rem; font-size: 0.75rem; margin-right: 0.25rem; margin-bottom: 0.25rem; }
        .presidente { background-color: #dbeafe; color: #1e40af; }
        .leitor { background-color: #fef3c7; color: #92400e; }
        .indicador { background-color: #d1fae5; color: #065f46; }
        .volante { background-color: #fce7f3; color: #be185d; }
        .palco { background-color: #f3e8ff; color: #6b21a8; }
        .today-highlight { background-color: #dbeafe; border-left: 5px solid #3b82f6; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 1.5rem; border-radius: 1rem; max-width: 90%; max-height: 90%; overflow-y: auto; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .btn-close { float: right; font-size: 1.5rem; font-weight: bold; cursor: pointer; }
        .nav-btn { background-color: #6366f1; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; font-size: 0.875rem; }
        .nav-btn:disabled { background-color: #9ca3af; cursor: not-allowed; }
        .table-title { font-size: 1.125rem; font-weight: 600; color: #1e293b; margin-bottom: 0.5rem; }
        .generic-table { width: 100%; border-collapse: collapse; margin-top: 0.5rem; }
        .generic-table th, .generic-table td { border: 1px solid #e2e8f0; padding: 0.5rem; text-align: left; font-size: 0.875rem; }
        .generic-table th { background-color: #f8fafc; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen font-sans">
    <div class="container mx-auto p-4 sm:p-6 max-w-5xl">
    

        <!-- Navegação de Semanas -->
        <div class="flex justify-center gap-4 mb-6">
            <button id="prev-week" onclick="changeWeek(-1)" class="nav-btn" disabled>Anterior</button>
            <button id="next-week" onclick="changeWeek(1)" class="nav-btn">Próxima</button>
        </div>

        <!-- Card da Semana Vigente -->
        <div id="week-card-container" class="flex justify-center">
            <!-- Card será inserido aqui -->
        </div>

        <!-- Modal de Programação Completa -->
        <div id="modal" class="modal">
            <div class="modal-content">
                <span class="btn-close" onclick="closeModal()">&times;</span>
                <div id="modal-body"></div>
            </div>
        </div>

        <!-- Rodapé -->
        <div class="mt-12 text-center text-xs text-gray-500">
            <p>Atualizado automaticamente • Congregação São Paulo</p>
        </div>
    </div>

    <script>
        // ==================== CONFIGURAÇÃO DO FIREBASE ====================
        const firebaseConfig = {
            apiKey: "AIzaSyD75RGb3lOiZ0azcSjtP_b9VcZPlHCelJY",
            authDomain: "territorios-3d0bb.firebaseapp.com",
            projectId: "territorios-3d0bb",
            storageBucket: "territorios-3d0bb.firebasestorage.app",
            messagingSenderId: "712377474662",
            appId: "1:712377474662:web:dfb86ef024b18aa2cb97a7",
            measurementId: "G-DME60YZGXX",
            databaseURL: "https://territorios-3d0bb-default-rtdb.firebaseio.com"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let allWeeks = [];
        let currentWeekIndex = 0;
        let allTables = {}; // Armazena todas as tabelas dinâmicas

        // ==================== CARREGAR DADOS (TABELAS DINÂMICAS) ====================
        document.addEventListener('DOMContentLoaded', loadData);

        function loadData() {
            const container = document.getElementById('week-card-container');
            container.innerHTML = '<div class="text-center py-10"><p class="text-gray-600">Carregando programação...</p></div>';

            Promise.all([
                database.ref('dynamicTables').once('value'),
                database.ref('tableData').once('value')
            ]).then(([tablesSnap, dataSnap]) => {
                const tablesConfig = tablesSnap.val() || {};
                const tablesData = dataSnap.val() || {};
                allTables = { config: tablesConfig, data: tablesData };

                // Extrair semanas das tabelas do tipo 'week'
                const weekTables = Object.entries(tablesConfig)
                    .filter(([_, cfg]) => cfg.type === 'week')
                    .map(([id]) => id);

                const rawWeeks = new Set();
                weekTables.forEach(id => {
                    const rows = tablesData[id] || [];
                    rows.forEach(row => {
                        if (row.col0) rawWeeks.add(row.col0);
                    });
                });

                allWeeks = ordenarSemanas(Array.from(rawWeeks));
                if (allWeeks.length === 0) {
                    container.innerHTML = '<p class="text-center text-gray-600 py-10">Nenhuma programação encontrada.</p>';
                    return;
                }

                // Encontrar semana vigente
                const hoje = new Date();
                currentWeekIndex = allWeeks.findIndex(week => semanaContemDia(week, hoje));
                if (currentWeekIndex === -1) currentWeekIndex = 0;

                renderCurrentWeek();
                updateNavButtons();
            }).catch(err => {
                console.error(err);
                container.innerHTML = '<p class="text-center text-red-600 py-10">Erro ao carregar dados.</p>';
            });
        }

        // ==================== RENDERIZAR SEMANA ATUAL ====================
        function renderCurrentWeek() {
            const container = document.getElementById('week-card-container');
            container.innerHTML = '';

            const week = allWeeks[currentWeekIndex];
            const isTodayWeek = semanaContemDia(week, new Date());
            const hoje = new Date();
            const diaAtualIndex = hoje.getDay();
            const diasSemana = ['Domingo', 'Segunda-Feira', 'Terça-Feira', 'Quarta-Feira', 'Quinta-Feira', 'Sexta-Feira', 'Sábado'];
            const diaAtualNome = diasSemana[diaAtualIndex];

            const card = document.createElement('div');
            card.className = `week-card bg-white rounded-xl shadow-lg p-6 max-w-3xl w-full ${isTodayWeek ? 'active' : ''}`;
            card.onclick = () => openModal(week);

            let contentHTML = `
                <div class="flex justify-between items-start mb-4">
                    <h2 class="text-2xl font-bold text-indigo-800">${week}</h2>
                    ${isTodayWeek ? '<span class="text-xs bg-green-100 text-green-800 px-3 py-1 rounded-full font-semibold">HOJE</span>' : ''}
                </div>
            `;

            // Processar cada tabela
            Object.entries(allTables.config).forEach(([tableId, config]) => {
                const data = allTables.data[tableId] || [];
                const row = data.find(r => normalizarSemana(r.col0) === normalizarSemana(week));

                if (config.type === 'week' && row) {
                    const title = config.title || 'Tabela';
                    const columns = config.columns || [];
                    contentHTML += `
                        <div class="mb-5 p-4 bg-purple-50 rounded-lg border border-purple-200">
                            <h3 class="font-semibold text-purple-900 mb-2">${title}</h3>
                            <div class="flex flex-wrap gap-2">
                    `;
                    columns.slice(1).forEach((colName, i) => {
                        const value = row[`col${i+1}`] || '';
                        if (value) {
                            contentHTML += `<span class="role" style="background:#e9d5ff;color:#6b21a8;">${colName}: ${value}</span>`;
                        }
                    });
                    contentHTML += `</div></div>`;
                }

                if (tableId === 'field' && isTodayWeek) {
                    const fieldRow = data.find(r => r.col0 === diaAtualNome);
                    if (fieldRow) {
                        contentHTML += `
                            <div class="mb-5 p-4 bg-blue-50 rounded-lg border border-blue-200 today-highlight">
                                <h3 class="font-semibold text-blue-900 mb-3">Saída de Campo - Hoje</h3>
                                <div class="bg-white p-4 rounded-lg border border-blue-100 shadow-sm">
                                    <p class="field-day text-base font-bold">${diaAtualNome}</p>
                                    <p class="text-sm"><strong>Local:</strong> ${fieldRow.col1 || '—'}</p>
                                    <p class="text-sm"><strong>Horário:</strong> ${fieldRow.col2 || '—'}</p>
                                    <p class="text-sm"><strong>Dirigente:</strong> ${fieldRow.col3 || '—'}</p>
                                </div>
                            </div>
                        `;
                    }
                }
            });

            contentHTML += `<p class="text-center text-sm text-indigo-600 mt-4 font-medium">Clique para ver programação completa →</p>`;
            card.innerHTML = contentHTML;
            container.appendChild(card);
        }

        // ==================== NAVEGAÇÃO ENTRE SEMANAS ====================
        function changeWeek(direction) {
            const newIndex = currentWeekIndex + direction;
            if (newIndex >= 0 && newIndex < allWeeks.length) {
                currentWeekIndex = newIndex;
                renderCurrentWeek();
                updateNavButtons();
            }
        }

        function updateNavButtons() {
            document.getElementById('prev-week').disabled = currentWeekIndex === 0;
            document.getElementById('next-week').disabled = currentWeekIndex === allWeeks.length - 1;
        }

        // ==================== MODAL DE PROGRAMAÇÃO COMPLETA ====================
        function openModal(week) {
            const modal = document.getElementById('modal');
            const body = document.getElementById('modal-body');
            const diasSemana = ['Domingo', 'Segunda-Feira', 'Terça-Feira', 'Quarta-Feira', 'Quinta-Feira', 'Sexta-Feira', 'Sábado'];

            let modalHTML = `<h2 class="text-2xl font-bold text-indigo-900 mb-6">${week} - Programação Completa</h2>`;

            Object.entries(allTables.config).forEach(([tableId, config]) => {
                const data = allTables.data[tableId] || [];
                const columns = config.columns || [];

                if (config.type === 'week') {
                    const row = data.find(r => normalizarSemana(r.col0) === normalizarSemana(week));
                    if (row) {
                        modalHTML += `
                            <div class="mb-6 p-5 bg-purple-50 rounded-xl border border-purple-200">
                                <h3 class="text-lg font-semibold text-purple-900 mb-3">${config.title}</h3>
                                <div class="space-y-2 text-lg">
                        `;
                        columns.slice(1).forEach((colName, i) => {
                            const value = row[`col${i+1}`] || '';
                            if (value) {
                                modalHTML += `<p><strong>${colName}:</strong> ${value}</p>`;
                            }
                        });
                        modalHTML += `</div></div>`;
                    }
                }

                if (tableId === 'field') {
                    modalHTML += `
                        <div class="mb-6 p-5 bg-blue-50 rounded-xl border border-blue-200">
                            <h3 class="text-lg font-semibold text-blue-900 mb-4">Saída de Campo - Todos os Dias</h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    `;
                    diasSemana.forEach(dia => {
                        const row = data.find(r => r.col0 === dia);
                        if (row) {
                            modalHTML += `
                                <div class="bg-white p-4 rounded-lg border border-blue-100 shadow">
                                    <p class="field-day font-bold">${dia}</p>
                                    <p class="text-sm"><strong>Local:</strong> ${row.col1 || '—'}</p>
                                    <p class="text-sm"><strong>Horário:</strong> ${row.col2 || '—'}</p>
                                    <p class="text-sm"><strong>Dirigente:</strong> ${row.col3 || '—'}</p>
                                </div>
                            `;
                        }
                    });
                    modalHTML += `</div></div>`;
                }

                // Tabelas genéricas
                if (config.type === 'generic' && data.length > 0) {
                    modalHTML += `
                        <div class="mb-6 p-5 bg-gray-50 rounded-xl border border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">${config.title}</h3>
                            <table class="generic-table">
                                <thead>
                                    <tr>
                                        ${columns.map(col => `<th>${col}</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    data.forEach(row => {
                        modalHTML += `<tr>`;
                        columns.forEach((_, i) => {
                            modalHTML += `<td>${row[`col${i}`] || ''}</td>`;
                        });
                        modalHTML += `</tr>`;
                    });
                    modalHTML += `</tbody></table></div>`;
                }
            });

            body.innerHTML = modalHTML;
            modal.style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        window.onclick = function(event) {
            const modal = document.getElementById('modal');
            if (event.target === modal) closeModal();
        }

        // ==================== FUNÇÕES AUXILIARES ====================
        function normalizarSemana(texto) {
            if (!texto) return '';
            return texto.replace(/[^\d–]/g, '').trim();
        }

        function ordenarSemanas(semanas) {
            const meses = { janeiro:0, fevereiro:1, março:2, abril:3, maio:4, junho:5,
                               julho:6, agosto:7, setembro:8, outubro:9, novembro:10, dezembro:11 };
            return semanas
                .map(s => {
                    const match = s.match(/(\d+)[–-](\d+)\s+de\s+([^\d–-]+)/i);
                    if (!match) return null;
                    const [, ini, fim, mesStr] = match;
                    const mes = meses[mesStr.toLowerCase()];
                    if (mes === undefined) return null;
                    const ano = new Date().getFullYear();
                    const dataIni = new Date(ano, mes, parseInt(ini));
                    return { texto: s, data: dataIni };
                })
                .filter(Boolean)
                .sort((a, b) => a.data - b.data)
                .map(item => item.texto);
        }

        function semanaContemDia(semanaTexto, dataHoje) {
            const match = semanaTexto.match(/(\d+)[–-](\d+)\s+de\s+([^\d–-]+)/i);
            if (!match) return false;
            const [, diaIni, diaFim, mesStr] = match;
            const meses = { janeiro:0, fevereiro:1, março:2, abril:3, maio:4, junho:5,
                               julho:6, agosto:7, setembro:8, outubro:9, novembro:10, dezembro:11 };
            const mes = meses[mesStr.toLowerCase()];
            if (mes === undefined) return false;

            const ano = dataHoje.getFullYear();
            const inicio = new Date(ano, mes, parseInt(diaIni));
            const fim = new Date(ano, mes, parseInt(diaFim));
            if (fim < inicio) fim.setMonth(fim.getMonth() + 1);

            return dataHoje >= inicio && dataHoje <= fim;
        }
    </script>
</body>
</html>