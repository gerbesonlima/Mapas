<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualização de Registros Arquivados de Território</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 15px;
            line-height: 1.4;
            background-color: #f8f8f8;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            padding: 15px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .controls {
            text-align: center;
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            background-color: #f9f9f9;
        }
        .controls label, .controls input, .controls button {
            margin: 5px;
            padding: 8px;
            font-size: 0.9em;
        }
        .controls input {
            width: 100px;
        }
        .controls button {
            cursor: pointer;
            background-color: #2c3e50;
            color: white;
            border: none;
            border-radius: 4px;
        }
        h1 {
            text-align: center;
            font-size: 1.4em;
            margin-bottom: 5px;
        }
        h2#serviceYearHeader {
            text-align: center;
            font-size: 1.1em;
            margin-top: 0;
            margin-bottom: 15px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
            font-size: 0.8em;
        }
        th, td {
            border: 1px solid #bbb;
            padding: 5px;
            text-align: center;
            vertical-align: middle;
        }
        th {
            background-color: #e0e0e0;
            font-weight: bold;
        }
        thead th.main-header {
            background-color: #c0c0c0;
        }
        td.name-cell {
            font-weight: bold;
            background-color: #f9f9f9;
        }
        tr.date-row td {
            font-size: 0.95em;
        }
        .footnote, .form-id {
            font-size: 0.75em;
            text-align: left;
            margin-top: 10px;
        }
        .col-terr-no { width: 5%; }
        .col-last-completed { width: 10%; }

        @media print {
            body { margin: 0; background-color: #fff; font-size: 7pt; }
            .container { box-shadow: none; padding: 0; max-width:100%;}
            .controls { display: none; }
            h1, h2 { color: #000; }
            th { background-color: #f2f2f2 !important; color: #000 !important; -webkit-print-color-adjust: exact; color-adjust: exact; }
            thead th.main-header { background-color: #d3d3d3 !important; -webkit-print-color-adjust: exact; color-adjust: exact; }
            td { color: #000 !important; padding: 3px; vertical-align: middle;}
            td.name-cell { background-color: #f9f9f9 !important; -webkit-print-color-adjust: exact; color-adjust: exact;}
            .footnote, .form-id { font-size: 0.7em; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="controls">
            <label for="cycleInput">Ano de Serviço (Ciclo):</label>
            <input type="text" id="cycleInput" placeholder="Ex: 2024 ou 1" value="2024">
            <button onclick="triggerLoad()">Carregar Dados</button> {/* Modificado para chamar triggerLoad */}
        </div>

        <h1>REGISTRO DE DESIGNAÇÃO DE TERRITÓRIO</h1>
        <h2 id="serviceYearHeader">Ano de Serviço: [Aguardando carregamento...]</h2>

        <table>
            <thead>
                <tr>
                    <th rowspan="2" class="col-terr-no main-header">Terr. n.º</th>
                    <th rowspan="2" class="col-last-completed main-header">Última data concluída*</th>
                    <th colspan="2" class="main-header">Designado para</th>
                    <th colspan="2" class="main-header">Designado para</th>
                    <th colspan="2" class="main-header">Designado para</th>
                    <th colspan="2" class="main-header">Designado para</th>
                </tr>
                <tr>
                    <th>Data da designação</th><th>Data da conclusão</th>
                    <th>Data da designação</th><th>Data da conclusão</th>
                    <th>Data da designação</th><th>Data da conclusão</th>
                    <th>Data da designação</th><th>Data da conclusão</th>
                </tr>
            </thead>
            <tbody id="archived_territory_table_body">
                </tbody>
        </table>
        <p class="footnote">*Ao iniciar uma nova folha, use esta coluna para registrar a data em que cada território foi concluído pela última vez.</p>
        <p class="form-id">S-13-T (Visualização de Arquivados)</p>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD75RGb3lOiZ0azcSjtP_b9VcZPlHCelJY",
            authDomain: "territorios-3d0bb.firebaseapp.com",
            projectId: "territorios-3d0bb",
            storageBucket: "territorios-3d0bb.firebasestorage.app",
            messagingSenderId: "712377474662",
            appId: "1:712377474662:web:dfb86ef024b18aa2cb97a7",
            measurementId: "G-DME60YZGXX",
            databaseURL: "https://territorios-3d0bb-default-rtdb.firebaseio.com"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        function formatFirebaseDate(dateString) {
            if (!dateString || String(dateString).trim() === "") return "";
            const parts = String(dateString).split("-");
            if (parts.length === 3) {
                const [year, month, day] = parts;
                return `${day}/${month}/${year.slice(-2)}`; // DD/MM/YY
            }
            return dateString; 
        }
        
        // Nova função para acionar o carregamento (chamada pelo botão e no onload)
        async function triggerLoad() {
            const cycleInputValue = document.getElementById('cycleInput').value.trim();
            // A função loadAndRenderArchivedData agora lida com cycleInputValue vazio
            await loadAndRenderArchivedData(cycleInputValue);
        }

        // Função principal modificada para aceitar o ciclo como parâmetro
        async function loadAndRenderArchivedData(selectedCycle) {
            const tbody = document.getElementById('archived_territory_table_body');
            const serviceYearHeader = document.getElementById('serviceYearHeader');

            if (!selectedCycle) {
                serviceYearHeader.textContent = 'Ano de Serviço: [Nenhum Ciclo Selecionado]';
                tbody.innerHTML = '<tr><td colspan="10">Por favor, insira um Ano de Serviço (Ciclo) e clique em "Carregar Dados".</td></tr>';
                return;
            }

            serviceYearHeader.textContent = `Ano de Serviço: ${selectedCycle}`;
            tbody.innerHTML = '<tr><td colspan="10">Carregando dados para o ciclo ' + selectedCycle + '...</td></tr>';

            try {
                const snapshot = await db.ref('historico_arquivado').once('value');
                const allArchivedData = snapshot.val();
                let processedData = {}; 
                let allTerritoryIds = new Set(); // Não usado diretamente para iterar de 1-38, mas bom para saber quais terrs têm dados

                if (allArchivedData) {
                    for (const key in allArchivedData) {
                        const record = allArchivedData[key];
                        if (record.mapa) { // Garante que o registro tem um mapa
                           allTerritoryIds.add(parseInt(record.mapa));
                        }
                        
                        // Comparação do ciclo do registro com o ciclo selecionado
                        if (String(record.ciclo) === String(selectedCycle)) {
                            if (!processedData[record.mapa]) {
                                processedData[record.mapa] = {
                                    assignments: [],
                                    ultimaDataConcluida: '' 
                                };
                            }
                            processedData[record.mapa].assignments.push({
                                nome: record.nome || '',
                                dataInicio: record.dataInicio || '',
                                dataFim: record.dataFim || ''
                            });
                        }
                    }
                }

                for (const mapId in processedData) {
                    processedData[mapId].assignments.sort((a, b) => {
                        if (!a.dataInicio) return 1; // Coloca registros sem data de início no final
                        if (!b.dataInicio) return -1;
                        if (a.dataInicio < b.dataInicio) return -1;
                        if (a.dataInicio > b.dataInicio) return 1;
                        return 0;
                    });
                }

                tbody.innerHTML = ''; 

                let foundDataForCycle = false;
                for (let i = 1; i <= 38; i++) {
                    const mapId = String(i);
                    const terrData = processedData[mapId];
                    let assignments = terrData ? terrData.assignments : [];
                    let ultimaData = ''; 

                    if (terrData) foundDataForCycle = true;

                    let namesRowHTML = `<tr><td rowspan="2">${mapId.padStart(2, '0')}</td><td rowspan="2">${formatFirebaseDate(ultimaData)}</td>`;
                    for (let j = 0; j < 4; j++) {
                        const assignment = assignments[j];
                        namesRowHTML += `<td colspan="2" class="name-cell">${assignment ? (assignment.nome || '') : ''}</td>`;
                    }
                    namesRowHTML += `</tr>`;
                    tbody.insertAdjacentHTML('beforeend', namesRowHTML);

                    let datesRowHTML = `<tr class="date-row">`;
                    for (let j = 0; j < 4; j++) {
                        const assignment = assignments[j];
                        datesRowHTML += `<td>${assignment ? formatFirebaseDate(assignment.dataInicio) : ''}</td>
                                         <td>${assignment ? formatFirebaseDate(assignment.dataFim) : ''}</td>`;
                    }
                    datesRowHTML += `</tr>`;
                    tbody.insertAdjacentHTML('beforeend', datesRowHTML);

                    // Lógica especial para Territórios 19 e 24 se tiverem mais de 4 designações
                    if ((mapId === "19" || mapId === "24") && assignments.length > 4) {
                        const fifthAssignment = assignments[4];
                        if (fifthAssignment) {
                            let extraNamesRowHTML = `<tr><td rowspan="2" style="font-style:italic;">${mapId.padStart(2, '0')} (cont.)</td><td rowspan="2"></td>`;
                            extraNamesRowHTML += `<td colspan="2" class="name-cell">${fifthAssignment.nome || ''}</td>`;
                            extraNamesRowHTML += `<td colspan="2" class="name-cell"></td> <td colspan="2" class="name-cell"></td> <td colspan="2" class="name-cell"></td>`;
                            extraNamesRowHTML += `</tr>`;
                            tbody.insertAdjacentHTML('beforeend', extraNamesRowHTML);

                            let extraDatesRowHTML = `<tr class="date-row">`;
                            extraDatesRowHTML += `<td>${formatFirebaseDate(fifthAssignment.dataInicio)}</td><td>${formatFirebaseDate(fifthAssignment.dataFim)}</td>`;
                            extraDatesRowHTML += `<td></td><td></td> <td></td><td></td> <td></td><td></td>`;
                            extraDatesRowHTML += `</tr>`;
                            tbody.insertAdjacentHTML('beforeend', extraDatesRowHTML);
                        }
                    }
                }
                 if (!foundDataForCycle && tbody.innerHTML === '') { // Verifica se dados foram encontrados E se o tbody está realmente vazio
                    tbody.innerHTML = `<tr><td colspan="10">Nenhum registro arquivado encontrado para o ciclo: ${selectedCycle}.</td></tr>`;
                }

            } catch (error) {
                console.error("Erro ao carregar dados arquivados:", error);
                serviceYearHeader.textContent = `Ano de Serviço: [Erro ao Carregar]`;
                tbody.innerHTML = '<tr><td colspan="10">Erro ao carregar dados. Verifique o console (F12).</td></tr>';
                alert("Erro ao carregar dados: " + error.message);
            }
        }
        
        // Carregar dados para o ciclo padrão (definido no value do input) ao iniciar a página
        window.onload = function() {
            triggerLoad(); // Chama a função que lê o input e carrega os dados
        };
    </script>
</body>
</html>