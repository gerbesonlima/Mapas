<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Designação de Território - Ano de Serviço: 2025</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0 10px;
            background-color: #f4f4f4;
        }
        h1 {
            text-align: center;
            color: #333;
            font-size: 2rem;
            margin: 20px 0;
        }
        .controls {
            text-align: center;
            margin-bottom: 20px;
        }
        .controls label, .controls select, .controls input {
            margin: 0 10px;
        }
        .controls button {
            padding: 8px 16px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            background-color: #2c3e50;
            color: #fff;
            font-size: 0.95em;
        }
        .controls button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .checkbox-group {
            margin: 10px 0;
        }
        .table-container {
            overflow-x: auto;
            max-width: 100%;
            margin: 0 auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            min-width: 900px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            font-size: 0.95em;
        }
        th {
            background-color: #2c3e50;
            color: #fff;
            font-weight: bold;
        }
        td {
            background-color: #f9f9f9;
        }
        tr:nth-child(even) td {
            background-color: #f1f1f1;
        }
        tr:hover td {
            background-color: #e0e0e0;
        }
        input[type="date"] {
            width: 100%;
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.95em;
            box-sizing: border-box;
        }
        input[readonly] {
            background-color: #e9ecef;
        }
        .hidden {
            display: none !important;
        }
        th.coluna1, td.coluna1 {
            width: 80px;
        }
        th.coluna2, td.coluna2 {
            width: 180px;
        }
        th.coluna3, td.coluna3 {
            min-width: 140px;
        }
        @media (max-width: 768px) {
            h1 {
                font-size: 1.5rem;
            }
            th, td {
                font-size: 0.85em;
                padding: 6px;
            }
            input[type="date"] {
                font-size: 0.85em;
                padding: 5px;
            }
            .controls button {
                font-size: 0.85em;
                padding: 6px 12px;
            }
        }
        @media (max-width: 480px) {
            h1 {
                font-size: 1.2rem;
            }
            th, td {
                font-size: 0.75em;
                padding: 4px;
            }
            input[type="date"] {
                font-size: 0.75em;
                padding: 4px;
            }
            .controls button {
                font-size: 0.75em;
                padding: 5px 10px;
            }
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD75RGb3lOiZ0azcSjtP_b9VcZPlHCelJY",
            authDomain: "territorios-3d0bb.firebaseapp.com",
            projectId: "territorios-3d0bb",
            storageBucket: "territorios-3d0bb.firebasestorage.app",
            messagingSenderId: "712377474662",
            appId: "1:712377474662:web:dfb86ef024b18aa2cb97a7",
            measurementId: "G-DME60YZGXX",
            databaseURL: "https://territorios-3d0bb-default-rtdb.firebaseio.com"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // State variables
        let isEditing = false;
        let numColumns = 4;
        let visibleColumns = [true, true, true, true]; // Tracks visibility of each "Designado para" column
        let tableData = {};
        let territoryIds = new Set();

        // Initialize table and load data
        window.onload = function() {
            loadTableData();
        };

        // Load data from Firebase
        function loadTableData() {
            // Fetch historicoMapas
            database.ref('historicoMapas').once('value').then((histSnapshot) => {
                const histData = histSnapshot.val();
                if (histData) {
                    Object.keys(histData).forEach(terr => {
                        if (!isNaN(terr)) {
                            territoryIds.add(parseInt(terr));
                        }
                    });
                }

                // Fetch historicoDesignacoes
                database.ref('historicoDesignacoes').once('value').then((designSnapshot) => {
                    const designData = designSnapshot.val();
                    if (designData) {
                        Object.values(designData).forEach(design => {
                            if (design.mapaId && !isNaN(design.mapaId)) {
                                territoryIds.add(parseInt(design.mapaId));
                            }
                        });
                    }

                    // Initialize tableData from Firebase or default
                    database.ref('tableData').once('value').then((snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            tableData = data;
                        }

                        // Initialize tableData for all territories found
                        territoryIds.forEach(terr => {
                            if (!tableData[terr]) {
                                tableData[terr] = {
                                    lastCompleted: '',
                                    assignments: [
                                        { startDate: '', endDate: '' },
                                        { startDate: '', endDate: '' },
                                        { startDate: '', endDate: '' },
                                        { startDate: '', endDate: '' }
                                    ]
                                };
                            }
                        });

                        // Populate lastCompleted from historicoMapas
                        if (histData) {
                            for (let terr in histData) {
                                if (!isNaN(terr) && territoryIds.has(parseInt(terr))) {
                                    const cycles = histData[terr].ciclos;
                                    const latestCycle = Object.values(cycles)[Object.values(cycles).length - 1];
                                    if (latestCycle) {
                                        tableData[terr].lastCompleted = latestCycle.dataFim || '';
                                    }
                                }
                            }
                        }

                        // Populate first assignment column from historicoDesignacoes
                        if (designData) {
                            for (let key in designData) {
                                const design = designData[key];
                                if (design.acao === 'designado' && design.mapaId && territoryIds.has(parseInt(design.mapaId))) {
                                    const terrId = parseInt(design.mapaId);
                                    // Only populate the first assignment column with dates
                                    if (!tableData[terrId].assignments[0].startDate) {
                                        tableData[terrId].assignments[0] = {
                                            startDate: design.dataDesignacao || design.timestamp.split('T')[0],
                                            endDate: ''
                                        };
                                    }
                                }
                            }
                        }

                        renderTable();
                        updateColumnVisibility();
                    });
                });
            }).catch((error) => {
                console.error('Erro ao carregar dados:', error);
                alert('Erro ao carregar dados do Firebase.');
            });
        }

        // Render the table
        function renderTable() {
            const table = document.getElementById('territoryTable');
            const sortedTerritories = Array.from(territoryIds).sort((a, b) => a - b);
            table.innerHTML = `
                <thead>
                    <tr>
                        <th class="coluna1" rowspan="2">Terr. n.º</th>
                        <th class="coluna2" rowspan="2">Última data concluída*</th>
                        ${visibleColumns[0] ? '<th class="coluna3">Designado para</th>' : '<th class="hidden"></th>'}
                        ${visibleColumns[1] ? '<th class="coluna3">Designado para</th>' : '<th class="hidden"></th>'}
                        ${visibleColumns[2] ? '<th class="coluna3">Designado para</th>' : '<th class="hidden"></th>'}
                        ${visibleColumns[3] ? '<th class="coluna3">Designado para</th>' : '<th class="hidden"></th>'}
                    </tr>
                    <tr>
                        ${visibleColumns[0] ? `
                            <th class="coluna3">Data da designação</th>
                            <th class="coluna3">Data da conclusão</th>
                        ` : `
                            <th class="hidden"></th>
                            <th class="hidden"></th>
                        `}
                        ${visibleColumns[1] ? `
                            <th class="coluna3">Data da designação</th>
                            <th class="coluna3">Data da conclusão</th>
                        ` : `
                            <th class="hidden"></th>
                            <th class="hidden"></th>
                        `}
                        ${visibleColumns[2] ? `
                            <th class="coluna3">Data da designação</th>
                            <th class="coluna3">Data da conclusão</th>
                        ` : `
                            <th class="hidden"></th>
                            <th class="hidden"></th>
                        `}
                        ${visibleColumns[3] ? `
                            <th class="coluna3">Data da designação</th>
                            <th class="coluna3">Data da conclusão</th>
                        ` : `
                            <th class="hidden"></th>
                            <th class="hidden"></th>
                        `}
                    </tr>
                </thead>
                <tbody>
                    ${sortedTerritories.map(terr => `
                        <tr>
                            <td class="coluna1">${terr}</td>
                            <td class="coluna2"><input type="date" value="${tableData[terr].lastCompleted || ''}" data-terr="${terr}" data-field="lastCompleted" ${isEditing ? '' : 'readonly'}></td>
                            ${visibleColumns[0] ? `
                                <td class="coluna3">
                                    <input type="date" value="${tableData[terr].assignments[0].startDate || ''}" data-terr="${terr}" data-assignment="0" data-field="startDate" ${isEditing ? '' : 'readonly'}>
                                </td>
                                <td class="coluna3">
                                    <input type="date" value="${tableData[terr].assignments[0].endDate || ''}" data-terr="${terr}" data-assignment="0" data-field="endDate" ${isEditing ? '' : 'readonly'}>
                                </td>
                            ` : `
                                <td class="hidden"></td>
                                <td class="hidden"></td>
                            `}
                            ${visibleColumns[1] ? `
                                <td class="coluna3">
                                    <input type="date" value="${tableData[terr].assignments[1].startDate || ''}" data-terr="${terr}" data-assignment="1" data-field="startDate" ${isEditing ? '' : 'readonly'}>
                                </td>
                                <td class="coluna3">
                                    <input type="date" value="${tableData[terr].assignments[1].endDate || ''}" data-terr="${terr}" data-assignment="1" data-field="endDate" ${isEditing ? '' : 'readonly'}>
                                </td>
                            ` : `
                                <td class="hidden"></td>
                                <td class="hidden"></td>
                            `}
                            ${visibleColumns[2] ? `
                                <td class="coluna3">
                                    <input type="date" value="${tableData[terr].assignments[2].startDate || ''}" data-terr="${terr}" data-assignment="2" data-field="startDate" ${isEditing ? '' : 'readonly'}>
                                </td>
                                <td class="coluna3">
                                    <input type="date" value="${tableData[terr].assignments[2].endDate || ''}" data-terr="${terr}" data-assignment="2" data-field="endDate" ${isEditing ? '' : 'readonly'}>
                                </td>
                            ` : `
                                <td class="hidden"></td>
                                <td class="hidden"></td>
                            `}
                            ${visibleColumns[3] ? `
                                <td class="coluna3">
                                    <input type="date" value="${tableData[terr].assignments[3].startDate || ''}" data-terr="${terr}" data-assignment="3" data-field="startDate" ${isEditing ? '' : 'readonly'}>
                                </td>
                                <td class="coluna3">
                                    <input type="date" value="${tableData[terr].assignments[3].endDate || ''}" data-terr="${terr}" data-assignment="3" data-field="endDate" ${isEditing ? '' : 'readonly'}>
                                </td>
                            ` : `
                                <td class="hidden"></td>
                                <td class="hidden"></td>
                            `}
                        </tr>
                    `).join('')}
                </tbody>
            `;
        }

        // Toggle edit mode
        function toggleEditMode() {
            isEditing = !isEditing;
            document.getElementById('editButton').textContent = isEditing ? 'Cancelar' : 'Editar';
            document.getElementById('saveButton').disabled = !isEditing;
            renderTable();
        }

        // Save data to Firebase
        function saveData() {
            const inputs = document.querySelectorAll('#territoryTable input');
            inputs.forEach(input => {
                const terr = input.dataset.terr;
                const field = input.dataset.field;
                const assignmentIndex = input.dataset.assignment;
                if (assignmentIndex !== undefined) {
                    tableData[terr].assignments[assignmentIndex][field] = input.value;
                } else {
                    tableData[terr][field] = input.value;
                }
            });
            database.ref('tableData').set(tableData).then(() => {
                alert('Dados salvos com sucesso!');
                toggleEditMode();
            }).catch((error) => {
                alert('Erro ao salvar dados: ' + error.message);
            });
        }

        // Update column visibility
        function updateColumnVisibility() {
            numColumns = parseInt(document.getElementById('colSelector').value);
            visibleColumns = [
                document.getElementById('col1').checked,
                document.getElementById('col2').checked,
                document.getElementById('col3').checked,
                document.getElementById('col4').checked
            ];
            // Ensure the number of visible columns does not exceed numColumns
            let visibleCount = visibleColumns.filter(v => v).length;
            if (visibleCount > numColumns) {
                alert(`Por favor, selecione no máximo ${numColumns} colunas.`);
                // Reset checkboxes to match numColumns
                let count = 0;
                for (let i = 0; i < 4; i++) {
                    if (count < numColumns) {
                        visibleColumns[i] = true;
                        document.getElementById(`col${i+1}`).checked = true;
                        count++;
                    } else {
                        visibleColumns[i] = false;
                        document.getElementById(`col${i+1}`).checked = false;
                    }
                }
            }
            renderTable();
        }
    </script>
</head>
<body>
    <h1>Registro de Designação de Território - Ano de Serviço: 2025</h1>
    <div class="controls">
        <label for="colSelector">Quantas colunas de designação exibir:</label>
        <select id="colSelector" onchange="updateColumnVisibility()">
            <option value="1">1 coluna</option>
            <option value="2">2 colunas</option>
            <option value="3">3 colunas</option>
            <option value="4" selected>4 colunas</option>
        </select>
        <div class="checkbox-group">
            <label><input type="checkbox" id="col1" checked onchange="updateColumnVisibility()"> Designado para 1</label>
            <label><input type="checkbox" id="col2" checked onchange="updateColumnVisibility()"> Designado para 2</label>
            <label><input type="checkbox" id="col3" checked onchange="updateColumnVisibility()"> Designado para 3</label>
            <label><input type="checkbox" id="col4" checked onchange="updateColumnVisibility()"> Designado para 4</label>
        </div>
        <button id="editButton" onclick="toggleEditMode()">Editar</button>
        <button id="saveButton" disabled onclick="saveData()">Salvar</button>
    </div>
    <div class="table-container">
        <table id="territoryTable"></table>
    </div>
</body>
</html>