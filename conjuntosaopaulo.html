<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-B">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Visitas por Quadra (Firebase)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #map { height: 70vh; width: 100%; }
        .controls { padding: 10px; text-align: center; background-color: #f4f4f4; border-bottom: 1px solid #ddd; }
        button { padding: 8px 15px; margin: 5px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px; }
        button:hover { background-color: #0056b3; }
        .quadra-label {
            background: transparent;
            border: none;
            box-shadow: none;
            color: #333;
            font-size: 14px;
            font-weight: bold;
            text-shadow: 0px 0px 3px white, 0px 0px 3px white, 0px 0px 3px white;
        }
    </style>
</head>
<body>
    <div class="controls">
        <h1>Conjunto São Paulo</h1>
        <p>Clique nas quadras para mudar seu status de visita. (Salvo no Firebase)</p>
        <button id="resetButton">Resetar Todas as Quadras</button>
    </div>
    <div id="map"></div>

    <script>
        // === INÍCIO DA CONFIGURAÇÃO DO FIREBASE ===
        // (Copiado do seu arquivo firebase.js)
        const firebaseConfig = {
            apiKey: "AIzaSyD75RGb3lOiZ0azcSjtP_b9VcZPlHCelJY",
            authDomain: "territorios-3d0bb.firebaseapp.com",
            projectId: "territorios-3d0bb",
            storageBucket: "territorios-3d0bb.firebasestorage.app", 
            messagingSenderId: "712377474662",
            appId: "1:712377474662:web:dfb86ef024b18aa2cb97a7",
            databaseURL: "https://territorios-3d0bb-default-rtdb.firebaseio.com"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        // Criamos uma referência específica para este mapa, para não misturar com os outros dados
        const dbRefQuadras = database.ref("conjuntoSaoPaulo/quadras");
        // === FIM DA CONFIGURAÇÃO DO FIREBASE ===


        // --- LÓGICA DO MAPA (LEAFLET) ---
    
        const centroDoMapa = [-5.109478250892787, -42.73159233037812]; // localização do mapa
        const zoomInicial = 16.5; // centralizar mapa

        const map = L.map('map').setView(centroDoMapa, zoomInicial);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);
// --- DEFINIÇÃO DAS COORDENADAS (Exemplos) ---
        // Para adicionar novas quadras:
        // 1. Crie uma nova constante (ex: const coords_QD = [ ... ]);
        // 2. Adicione os 4 pares de [latitude, longitude] dos cantos da quadra.
        // 3. Adicione a linha `quadras.push(createQuadra('Q-D', coords_QD));` mais abaixo.

        const coords_QA = [
            [-5.109188053652607, -42.73280229934059], // Canto Superior Esquerdo
            [-5.109130992916853, -42.73244419324904], // Canto Superior Direito
            [-5.11106377910359, -42.73189542392853], // Canto Inferior Direito
            [-5.111329369444862, -42.73220578777016]  // Canto Inferior Esquerdo
        ];

        const coords_QB = [
            [-5.1089477603495315, -42.732385011955685], // Canto Superior Esquerdo
            [-5.1087997258549525, -42.73206153415373], // Canto Superior Direito
            [-5.110737292028634, -42.731554023433404], // Canto Inferior Direito
            [-5.110990593174692, -42.73182246411993]  // Canto Inferior Esquerdo
        ];

        const coords_QC = [
            [-5.1087544978677935, -42.731980641116124], // Canto Superior Esquerdo
            [-5.10858895323453, -42.73168600522402], // Canto Superior Direito
            [-5.110450073790369, -42.73116220807302], // Canto Inferior Direito
            [-5.110670799320684, -42.73147195349726]  // Canto Inferior Esquerdo
        ];

        // Exemplo para adicionar uma nova quadra 'Q-D':
        // const coords_QD = [
        //     [lat, long], // Canto Superior Esquerdo
        //     [lat, long], // Canto Superior Direito
        //     [lat, long], // Canto Inferior Direito
        //     [lat, long]  // Canto Inferior Esquerdo
        // ];

        // Definição dos estilos de status
        const statusStyles = {
            'Pendente': { color: '#ff0000', fillColor: '#ffcccc', fillOpacity: 0.7, weight: 2 },
            'Em Andamento': { color: '#ffa500', fillColor: '#ffe0b3', fillOpacity: 0.7, weight: 2 },
            'Concluído': { color: '#008000', fillColor: '#ccffcc', fillOpacity: 0.7, weight: 2 }
        };

        // Função para criar uma quadra
        function createQuadra(name, coordinates, initialStatus = 'Pendente') {
            const quadra = L.polygon(coordinates, statusStyles[initialStatus]).addTo(map);
            quadra.bindPopup(`<b>Quadra: ${name}</b><br>Status: ${initialStatus}`);
            
            quadra.bindTooltip(initialStatus, {
                permanent: true, 
                direction: 'center', 
                className: 'quadra-label'
            }).openTooltip();
            
            quadra.name = name;
            quadra.status = initialStatus;

            // Adiciona interação de clique
            quadra.on('click', function() {
                if (this.status === 'Pendente') {
                    this.status = 'Em Andamento';
                } else if (this.status === 'Em Andamento') {
                    this.status = 'Concluído';
                } else {
                    this.status = 'Pendente';
                }
                this.setStyle(statusStyles[this.status]);
                this.getPopup().setContent(`<b>Quadra: ${this.name}</b><br>Status: ${this.status}`);
                this.getTooltip().setContent(this.status);
                
                // --- MODIFICADO ---
                // Salva o status no Firebase em vez do localStorage
                saveQuadraStatus(this.name, this.status);
            });
            return quadra;
        }

        // Array para armazenar todas as quadras
        const quadras = [];

        // Cria as quadras e adiciona ao array
        quadras.push(createQuadra('Q-A', coords_QA));
        quadras.push(createQuadra('Q-B', coords_QB));
        quadras.push(createQuadra('Q-C', coords_QC));
        // Adicione mais quadras aqui...


        // --- FUNCIONALIDADES DE SALVAR E CARREGAR (MODIFICADAS PARA FIREBASE) ---

        /**
         * MODIFICADO: Salva o status de uma quadra específica no Firebase.
         */
        function saveQuadraStatus(name, status) {
            // Salva no Firebase sob o 'name' (ex: 'Q-A')
            // O caminho será: conjuntoSaoPaulo/quadras/Q-A
            dbRefQuadras.child(name).set({ status: status })
                .catch(error => console.error("Erro ao salvar status:", error));
        }

        /**
         * MODIFICADO: Carrega o status de TODAS as quadras do Firebase.
         */
        // --- MODIFICADO: Carrega e Ouve Sincronização em Tempo Real ---
        // Este bloco substitui a função 'loadAllQuadrasStatus' e sua chamada.
        // Ele é executado uma vez e, a partir daí, "ouve" as mudanças no Firebase.
        
        dbRefQuadras.on('value', (snapshot) => {
            const savedStatuses = snapshot.val() || {}; // Ex: { "Q-A": { status: "Concluído" }, ... }
            console.log("Sincronização: Novos dados recebidos do Firebase:", savedStatuses);

            quadras.forEach(quadra => {
                const savedData = savedStatuses[quadra.name]; // Busca pelo nome, ex: "Q-A"
                let newStatus = 'Pendente'; // Define o padrão

                // Se encontrou dados salvos para esta quadra
                if (savedData && savedData.status && statusStyles[savedData.status]) {
                    newStatus = savedData.status;
                }
                
                // Se o status no mapa for diferente do status no Firebase, atualiza
                if (quadra.status !== newStatus) {
                    quadra.status = newStatus;
                    quadra.setStyle(statusStyles[newStatus]);
                    quadra.getPopup().setContent(`<b>Quadra: ${quadra.name}</b><br>Status: ${quadra.status}`);
                    quadra.getTooltip().setContent(quadra.status);
                }
            });

        }, (error) => {
            // Função para caso o listener falhe (ex: falta de permissão)
            console.error("Erro ao sincronizar com o Firebase:", error);
            alert("Erro de conexão. Não foi possível sincronizar os status.");
        });
        
        // Carrega o status do Firebase ao iniciar
        // (Note que agora esta função é 'async' e é chamada assim)
        loadAllQuadrasStatus();

        
        /**
         * MODIFICADO: Botão de resetar agora limpa os dados no Firebase.
         */
        document.getElementById('resetButton').addEventListener('click', function() {
            if (confirm('Tem certeza que deseja resetar o status de todas as quadras no FIREBASE para "Pendente"?')) {
                
                // A forma mais fácil de resetar é remover a entrada "conjuntoSaoPaulo/quadras" do Firebase.
                // Na próxima vez que a página carregar, o 'loadAllQuadrasStatus' não encontrará dados
                // e todas as quadras voltarão ao estado 'Pendente' padrão.
                
                dbRefQuadras.remove()
                    .then(() => {
                        // Atualiza a interface localmente também
                        quadras.forEach(quadra => {
                            quadra.status = 'Pendente';
                            quadra.setStyle(statusStyles['Pendente']);
                            quadra.getPopup().setContent(`<b>Quadra: ${quadra.name}</b><br>Status: ${quadra.status}`);
                            quadra.getTooltip().setContent('Pendente');
                        });
                        alert('Todos os status foram resetados para "Pendente" no Firebase.');
                    })
                    .catch(error => {
                        console.error("Erro ao resetar no Firebase:", error);
                        alert("Erro ao resetar status no Firebase.");
                    });
            }
        });

    </script>
</body>
</html>