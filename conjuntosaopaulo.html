<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-B">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conjunto S√£o Paulo</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #map { height: 70vh; width: 100%; }
        .controls { padding: 10px; text-align: center; background-color: #f4f4f4; border-bottom: 1px solid #ddd; }
        button { padding: 8px 15px; margin: 5px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px; }
        button:hover { background-color: #0056b3; }
        .quadra-label {
            background: transparent;
            border: none;
            box-shadow: none;
            color: #333;
            font-size: 14px;
            font-weight: bold;
            text-shadow: 0px 0px 3px white, 0px 0px 3px white, 0px 0px 3px white;
        }
    </style>
</head>
<body>
    <div class="controls">
        <h1>Conjunto S√£o Paulo</h1>
        <p>Clique nas quadras para mudar seu status de visita.</p>
        <button id="resetButton">Resetar Todas as Quadras</button>
        <button id="locateButton">üìç Encontrar Minha Localiza√ß√£o</button> 
    </div>
    <div id="map"></div>

    <script>
        // === IN√çCIO DA CONFIGURA√á√ÉO DO FIREBASE ===
        const firebaseConfig = {
            apiKey: "AIzaSyD75RGb3lOiZ0azcSjtP_b9VcZPlHCelJY",
            authDomain: "territorios-3d0bb.firebaseapp.com",
            projectId: "territorios-3d0bb",
            storageBucket: "territorios-3d0bb.firebasestorage.app", 
            messagingSenderId: "712377474662",
            appId: "1:712377474662:web:dfb86ef024b18aa2cb97a7",
            databaseURL: "https://territorios-3d0bb-default-rtdb.firebaseio.com"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const dbRefQuadras = database.ref("conjuntoSaoPaulo/quadras");
        // === FIM DA CONFIGURA√á√ÉO DO FIREBASE ===


        // --- L√ìGICA DO MAPA (LEAFLET) ---
    
        const centroDoMapa = [-5.109478250892787, -42.73159233037812]; 
        const zoomInicial = 16.5; 

        const map = L.map('map').setView(centroDoMapa, zoomInicial);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        // --- DEFINI√á√ÉO DAS COORDENADAS ---
        const coords_QA = [
            [-5.109188053652607, -42.73280229934059], // Canto Superior Esquerdo
            [-5.109130992916853, -42.73244419324904], // Canto Superior Direito
            [-5.11106377910359, -42.73189542392853], // Canto Inferior Direito
            [-5.111329369444862, -42.73220578777016]  // Canto Inferior Esquerdo
        ];
        const coords_QB = [
            [-5.1089477603495315, -42.732385011955685], // Canto Superior Esquerdo
            [-5.1087997258549525, -42.73206153415373], // Canto Superior Direito
            [-5.110737292028634, -42.731554023433404], // Canto Inferior Direito
            [-5.110990593174692, -42.73182246411993]  // Canto Inferior Esquerdo
        ];
        const coords_QC = [
            [-5.1087544978677935, -42.731980641116124], // Canto Superior Esquerdo
            [-5.10858895323453, -42.73168600522402], // Canto Superior Direito
            [-5.110450073790369, -42.73116220807302], // Canto Inferior Direito
            [-5.110670799320684, -42.73147195349726]  // Canto Inferior Esquerdo
        ];
         const coords_QD = [
            [-5.108537158014731, -42.73160473577895], // Canto Superior Esquerdo
            [-5.108338787701675, -42.73129404401757], // Canto Superior Direito
            [-5.1098344983540445, -42.73088377156201], // Canto Inferior Direito
            [-5.110084444355055, -42.73117056395714]  // Canto Inferior Esquerdo
        ];
         const coords_QE = [
            [-5.108306336962282, -42.73122109068097], // Canto Superior Esquerdo
            [-5.108107767503081, -42.73090076866613], // Canto Superior Direito
            [-5.109543358367828, -42.730472436439925], // Canto Inferior Direito
            [-5.1097999362961595, -42.73079275845477]  // Canto Inferior Esquerdo
        ];

        // Defini√ß√£o dos estilos de status
        const statusStyles = {
            'Pendente': { color: '#ff0000', fillOpacity: 0, weight: 2 }, // Apenas borda vermelha
            'Em Andamento': { color: '#ffa500', fillColor: '#ffe0b3', fillOpacity: 0.7, weight: 2 },
            'Conclu√≠do': { color: '#008000', fillColor: '#ccffcc', fillOpacity: 0.7, weight: 2 }
        };

        // Fun√ß√£o para criar uma quadra
        function createQuadra(name, coordinates, initialStatus = 'Pendente') {
            const quadra = L.polygon(coordinates, statusStyles[initialStatus]).addTo(map);
            // O popup (ao clicar) continua mostrando o status
            quadra.bindPopup(`<b>Quadra: ${name}</b><br>Status: ${initialStatus}`);
            
            // ===== MUDAN√áA 1 =====
            // O tooltip (texto fixo) agora mostra o 'name' (Q-A) em vez do 'initialStatus'
            quadra.bindTooltip(name, { 
                permanent: true, 
                direction: 'center', 
                className: 'quadra-label'
            }).openTooltip();
            
            quadra.name = name;
            quadra.status = initialStatus;

            // Adiciona intera√ß√£o de clique (L√ìGICA DO STATUS N√ÉO MUDOU)
            quadra.on('click', function() {
                if (this.status === 'Pendente') {
                    this.status = 'Em Andamento';
                } else if (this.status === 'Em Andamento') {
                    this.status = 'Conclu√≠do';
                } else {
                    this.status = 'Pendente';
                }
                // A cor (estilo) continua mudando
                this.setStyle(statusStyles[this.status]);
                // O popup (ao clicar) continua sendo atualizado
                this.getPopup().setContent(`<b>Quadra: ${this.name}</b><br>Status: ${this.status}`);
                
                // ===== MUDAN√áA 2 =====
                // A linha que mudava o texto fixo foi REMOVIDA.
                // this.getTooltip().setContent(this.status); <-- REMOVIDA
                
                // O salvamento no Firebase continua igual
                saveQuadraStatus(this.name, this.status);
            });
            return quadra;
        }

        // Array para armazenar todas as quadras
        const quadras = [];

        // Cria as quadras e adiciona ao array
        quadras.push(createQuadra('Q-A', coords_QA));
        quadras.push(createQuadra('Q-B', coords_QB));
        quadras.push(createQuadra('Q-C', coords_QC));
        quadras.push(createQuadra('Q-D', coords_QD));
        quadras.push(createQuadra('Q-E', coords_QE));
        // Adicione mais quadras aqui...


        // --- FUNCIONALIDADES DE SALVAR E CARREGAR ---

        function saveQuadraStatus(name, status) {
            dbRefQuadras.child(name).set({ status: status })
                .catch(error => console.error("Erro ao salvar status:", error));
        }

        // Sincroniza√ß√£o em Tempo Real
        dbRefQuadras.on('value', (snapshot) => {
            const savedStatuses = snapshot.val() || {}; 
            console.log("Sincroniza√ß√£o: Novos dados recebidos do Firebase:", savedStatuses);

            quadras.forEach(quadra => {
                const savedData = savedStatuses[quadra.name]; 
                let newStatus = 'Pendente'; 

                if (savedData && savedData.status && statusStyles[savedData.status]) {
                    newStatus = savedData.status;
                }
                
                // A l√≥gica de status (cor, popup) continua igual
                if (quadra.status !== newStatus) {
                    quadra.status = newStatus;
                    quadra.setStyle(statusStyles[newStatus]);
                    quadra.getPopup().setContent(`<b>Quadra: ${quadra.name}</b><br>Status: ${quadra.status}`);
                    
                    // ===== MUDAN√áA 3 =====
                    // A linha que mudava o texto fixo na sincroniza√ß√£o foi REMOVIDA.
                    // quadra.getTooltip().setContent(quadra.status); <-- REMOVIDA
                }
            });

        }, (error) => {
            console.error("Erro ao sincronizar com o Firebase:", error);
            alert("Erro de conex√£o. N√£o foi poss√≠vel sincronizar os status.");
        });

      
        // Bot√£o de Resetar (L√≥gica n√£o mudou)
        document.getElementById('resetButton').addEventListener('click', function() {
            if (confirm('Tem certeza que deseja resetar o status de todas as quadras no FIREBASE para "Pendente"?')) {
                
                dbRefQuadras.remove()
                    .then(() => {
                        // O 'dbRefQuadras.on' vai detectar isso e atualizar o mapa sozinho
                        alert('Todos os status foram resetados para "Pendente" no Firebase.');
                    })
                    .catch(error => {
                        console.error("Erro ao resetar no Firebase:", error);
                        alert("Erro ao resetar status no Firebase.");
                    });
            }
        });


        // --- L√ìGICA DE GEOLOCALIZA√á√ÉO (PONTO AZUL) ---
        // (Isso foi da nossa conversa anterior, continua aqui)

        let userDot = null;
        let accuracyCircle = null;

        function onLocationFound(e) {
            const radius = e.accuracy / 2;
            const latlng = e.latlng;

            if (!userDot) {
                userDot = L.circleMarker(latlng, {
                    radius: 8,
                    color: '#007bff',       
                    fillColor: '#007bff',    
                    fillOpacity: 1,
                    weight: 2
                }).addTo(map).bindPopup("Voc√™ est√° aqui!");

                accuracyCircle = L.circle(latlng, radius, {
                    color: '#007bff',
                    fillColor: '#007bff',
                    fillOpacity: 0.15,
                    weight: 1
                }).addTo(map);

                map.setView(latlng, 18); 
            } else {
                userDot.setLatLng(latlng);
                accuracyCircle.setLatLng(latlng).setRadius(radius);
            }
        }

        function onLocationError(e) {
            let errorMsg = "N√£o foi poss√≠vel obter sua localiza√ß√£o.\n";
            switch(e.code) {
                case 1: errorMsg += "Permiss√£o negada."; break;
                case 2: errorMsg += "Localiza√ß√£o indispon√≠vel."; break;
                case 3: errorMsg += "Tempo esgotado."; break;
                default: errorMsg += "Erro desconhecido.";
            }
            alert(errorMsg);
        }

        document.getElementById('locateButton').addEventListener('click', function() {
            if (!navigator.geolocation) {
                alert("Seu navegador n√£o suporta geolocaliza√ß√£o.");
                return;
            }

            navigator.geolocation.watchPosition(
                (position) => {
                    const leafletEvent = {
                        latlng: L.latLng(position.coords.latitude, position.coords.longitude),
                        accuracy: position.coords.accuracy
                    };
                    onLocationFound(leafletEvent);
                },
                onLocationError, 
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
            
            this.textContent = "Seguindo localiza√ß√£o...";
            this.disabled = true; 
        });

    </script>
</body>
</html>