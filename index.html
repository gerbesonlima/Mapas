<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Territórios Abertos</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-messaging-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>

    <link rel="manifest" href="manifest.json">
    
    <script src="firebase.js"></script>
    
    <style>
        span {
    display: block;
    background-color: #fdfdfd;
    padding: 5vw;
    margin: 5vw 0;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    font-family: 'Segoe UI', 'Roboto', sans-serif;
    font-size: 4vw;
    line-height: 1.7;
    color: #222;
    box-sizing: border-box;
}

span p {
    margin-bottom: 4vw;
    text-align: justify;
}

span p:first-child {
    font-weight: bold;
}

span p::before {
    content: "• ";
    color: #4a90e2;
    font-weight: bold;
}

/* Ajustes para telas maiores */
@media (min-width: 600px) {
    span {
        font-size: 1.1rem;
        padding: 24px;
        margin: 24px 0;
    }

    span p {
        margin-bottom: 16px;
    }
}

/* ====================================================================
ESTILOS DO TOAST (NOTIFICAÇÃO)
(Movidos para aqui para garantir que carregam,
embora o ideal fosse estarem no style.css)
====================================================================
*/
#toast-notification {
    visibility: hidden; 
    min-width: 250px;
    max-width: 90%;
    background-color: #4CAF50; /* Verde sucesso */
    color: white;
    text-align: center;
    border-radius: 8px;
    padding: 16px;
    position: fixed;
    z-index: 2000;
    left: 50%;
    transform: translateX(-50%);
    bottom: 30px;
    font-size: 1rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    transition: visibility 0.5s, opacity 0.5s, bottom 0.5s ease-out;
    opacity: 0;
}
#toast-notification.show {
    visibility: visible;
    opacity: 1;
    bottom: 50px;
}
#toast-notification.error {
    background-color: #D32F2F; /* Vermelho erro */
}


/* ====================================================================
ESTILOS DO MODAL DE PERMISSÃO
====================================================================
*/
.modal-overlay {
    display: none; /* Começa escondido */
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.6);
}

.modal-content {
    background-color: #fefefe;
    margin: 40% auto; /* Mais centrado para mobile */
    padding: 25px;
    border: 1px solid #888;
    width: 90%;
    max-width: 400px; /* Limite de largura */
    border-radius: 10px;
    position: relative;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    text-align: center;
}

.modal-content h2 {
    font-size: 1.3rem;
    font-weight: 500;
    color: #333;
    margin-top: 0;
    margin-bottom: 15px;
}

.modal-content p {
    font-size: 1rem;
    color: #555;
    margin-bottom: 25px;
    line-height: 1.5;
}

.modal-buttons {
    display: flex;
    justify-content: space-between;
    gap: 10px;
}

.modal-button {
    flex: 1; /* Ocupa metade do espaço */
    padding: 12px;
    font-size: 1rem;
    font-weight: bold;
    border: none;
    border-radius: 8px;
    cursor: pointer;
}

#notificacao-sim {
    background-color: #0a6f0e; /* Verde */
    color: white;
}

#notificacao-nao {
    background-color: #ddd; /* Cinza claro */
    color: #333;
}

    </style>
     <a href="territorios.html"><button>Todos os Territórios</button></a> <br>

  
</head>


<body class="container">

    <button id="botao-instalar" style="display: none; width: 90%; max-width: 400px; margin: 15px auto; padding: 14px; font-size: 16px; font-weight: bold; background-color: #0a6f0e; color: white; border: none; border-radius: 8px; cursor: pointer; text-align: center;">
        Instalar Aplicativo
    </button>
    
    <div id="territorios-container">
    </div>
      
    <footer>
        <div class="footer-links">
            <a href="instrucoes.html">Instruções de uso</a>
            <a href="https://drive.google.com/drive/folders/17xHF437Jhg3uzSI7jQRcs7rSoj15lCdn?usp=drive_link">Mapas do Drive</a>
            
            <a href="#" onclick="solicitarPermissaoNotificacao(); return false;" style="color: #4a90e2; font-weight: bold;">
                Ativar Notificações
            </a>
        </div>
        <a href="https://www.google.com/maps/d/edit?mid=1FON3gzyF0S1UcXrQl67SnU0Rp0Af4TU&usp=sharing">Mapa geral dos Territórios</a>
        <p>© 2025 Mapas dos Territórios</p>
    </footer>

<script>
        // Variável global para guardar o evento de instalação
        let deferredPrompt;
        // As variáveis 'toastTimer' e 'showToast' estão agora no firebase.js
        // As variáveis 'functions' e 'messaging' também estão no firebase.js


        document.addEventListener("DOMContentLoaded", () => {
            
            // --- LÓGICA DE INSTALAÇÃO DO PWA ---
            const btnInstalar = document.getElementById('botao-instalar');

            window.addEventListener('beforeinstallprompt', (e) => {
                console.log('beforeinstallprompt disparado');
                e.preventDefault();
                deferredPrompt = e;
                if(btnInstalar) {
                    btnInstalar.style.display = 'block';
                }
            });

            if(btnInstalar) {
                btnInstalar.addEventListener('click', () => {
                    console.log('Botão de instalar clicado');
                    btnInstalar.style.display = 'none';
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        deferredPrompt.userChoice.then((choiceResult) => {
                            if (choiceResult.outcome === 'accepted') {
                                console.log('Usuário aceitou a instalação');
                            } else {
                                console.log('Usuário recusou a instalação');
                            }
                            deferredPrompt = null;
                        });
                    }
                });
            }
            
            window.addEventListener('appinstalled', () => {
                if(btnInstalar) {
                    btnInstalar.style.display = 'none';
                }
                deferredPrompt = null;
                console.log('PWA foi instalado');
            });
            // --- FIM DA LÓGICA DE INSTALAÇÃO ---

            
            // --- LÓGICA DO MODAL DE PROGRAMAÇÃO ---
            const modalProg = document.getElementById("modal-programacao");
            const fecharBtnProg = document.getElementById("fechar-modal");

            if (fecharBtnProg) {
                fecharBtnProg.onclick = fecharModalProgramacao;
            }
            if (modalProg) {
                window.addEventListener('click', (event) => {
                    if (event.target == modalProg) {
                        fecharModalProgramacao();
                    }
                });
            }
            // --- FIM LÓGICA MODAL PROGRAMAÇÃO ---


            // *** LÓGICA: MODAL DE PERMISSÃO DE NOTIFICAÇÃO ***
            const modalNotif = document.getElementById("modal-notificacao");
            const btnNotifSim = document.getElementById("notificacao-sim");
            const btnNotifNao = document.getElementById("notificacao-nao");

            if(btnNotifSim) {
                btnNotifSim.addEventListener('click', () => {
                    solicitarPermissaoNotificacao(); // Esta função ESTÁ no firebase.js
                    modalNotif.style.display = "none";
                });
            }
            if(btnNotifNao) {
                btnNotifNao.addEventListener('click', () => {
                    modalNotif.style.display = "none";
                });
            }

            if (window.matchMedia('(display-mode: standalone)').matches && Notification.permission === 'default') {
                setTimeout(() => {
                    if (modalNotif) modalNotif.style.display = "block";
                }, 2000);
            }
            // *** FIM DA LÓGICA DE PERMISSÃO ***


            // O resto do seu código de carregar territórios
            carregarTerritoriosAbertos();
        });

        /**
         * Retorna o nome do dia da semana atual em português.
         */
        function getTodayDayName() {
            const days = ["Domingo", "Segunda-Feira", "Terça-Feira", "Quarta-Feira", "Quinta-Feira", "Sexta-Feira", "Sábado"];
            const todayIndex = new Date().getDay();
            return days[todayIndex];
        }

        /**
         * Formata uma data (string ISO ou objeto Date) para "dd/mm/aaaa às HH:MM".
         */
        function formatarData(dataISO) {
            if (!dataISO) return "";
            try {
                const data = new Date(dataISO);
                const dia = String(data.getDate()).padStart(2, '0');
                const mes = String(data.getMonth() + 1).padStart(2, '0'); // Mês é 0-indexado
                const ano = data.getFullYear();
                const horas = String(data.getHours()).padStart(2, '0');
                const minutos = String(data.getMinutes()).padStart(2, '0');
                return `${dia}/${mes}/${ano} às ${horas}:${minutos}`;
            } catch (e) {
                console.error("Erro ao formatar data:", e);
                return ""; 
            }
        }

        function carregarTerritoriosAbertos() {
            const container = document.getElementById("territorios-container");
            container.innerHTML = "<p>Carregando programação e territórios...</p>";

            // Definições de grupos e mapas
            const grupos = [
                { id: "grupo2", nome: "Grupo 02 - Saída casa do Robson", mapaIds: [1, 2, 3, 4, 5, 6] },
                { id: "grupo3", nome: "Grupo 03 - Saída casa da Raimundinha", mapaIds: [7, 8, 9, 10, 11, 12] },
                { id: "grupo4", nome: "Grupo 04 - Saída casa do José Lopes", mapaIds: [13, 14, 15, 16, 17, 18, 19, 20] },
                { id: "grupo1-2", nome: "Grupo 01 - Saída do Salão do Reino", mapaIds: [21, 22, 23, 24, 25] },
                { id: "grupo5", nome: "Grupo 05 - Saída do Fernando", mapaIds: [26, 27, 28, 29, 30, 31, 32, 33, 34] },
                { id: "grupo6", nome: "Grupo 06 - Saída Casa do Walter", mapaIds: [35, 36, 37, 38] }
            ];

            const mapaInfo = {
                1: { nome: "1 Conjunto São Paulo", link: "https://goo.gl/maps/Md49jEyZRj3EvN6v9" },
                2: { nome: "2 Curva São Paulo", link: "https://www.google.com/maps/d/edit?mid=1r6jF2LI2ux7isdXChAk4B4nROMWCICg&usp=sharing" },
                3: { nome: "3 Vila Beira Rio", link: "https://www.google.com/maps/d/edit?mid=12PrxH_RXHnTg3Hrp8zp8oD3bpQvhG_c&usp=sharing" },
                4: { nome: "4 Res Araguaia (parte A)", link: "https://www.google.com/maps/d/edit?mid=195rUyTh_G2LjbtAkXVp2LvBEwv997Po&usp=sharing" },
                5: { nome: "5 Res Araguaia (parte B)", link: "https://www.google.com/maps/d/edit?mid=12gcziapB8ifTF4qB0JIERIbZO1dNKIw&usp=sharing" },
                6: { nome: "6 Vila Bagda", link: "https://www.google.com/maps/d/edit?mid=1MYrUYQJ1id99b_MZ7-xi5hrfKlyMAKE&usp=sharing" },
                7: { nome: "7 Vila Firmino (parte A)", link: "https://www.google.com/maps/d/viewer?mid=18Wxukw79C2pPGSVY3Ql8vD2n1oCEAis&hl=pt-BR&usp=sharing" },
                8: { nome: "8 Vila Firmino (parte B)", link: "https://www.google.com/maps/d/viewer?mid=1GOBDMjUsQ1wS1sbzGHKeR-DS5kIkKGs&usp=sharing" },
                9: { nome: "9 Parque Poty (parte A)", link: "https://www.google.com/maps/d/edit?mid=19ZUY-pf4uECpRL1FVBb7QEpJTBCyZ4k&usp=sharing" },
                10: { nome: "10 Parque Poty (parte B)", link: "https://www.google.com/maps/d/edit?mid=1ghYlY5uOxIulSEhXv8EasZ8WYd7M_z0&usp=sharing" },
                11: { nome: "11 Parque Poty (parte C)", link: "https://www.google.com/maps/d/edit?mid=1u5nwR0cBiF3FK23HfZKwMqHjBO6SgZk&usp=sharing" },
                12: { nome: "12 Vila Poty", link: "https://www.google.com/maps/d/edit?mid=1o7VZi5ay3WxZ9NOn--yQTeJwmpAnbc8&usp=sharing" },
                13: { nome: "13 Sales", link: "https://www.google.com/maps/d/edit?mid=10O9KCa9g8fKSbOwHPP8OY414bXSo-m8&usp=sharing" },
                14: { nome: "14 Cidade Nova", link: "https://www.google.com/maps/d/edit?mid=19nBg9H9jwTf3bDDtOLTaAd2K3l_KWG0&usp=sharing" },
                15: { nome: "15 Porto Rico", link: "https://www.google.com/maps/d/edit?mid=1cydoQcQmHEk-1R95mH0ez_Fbt3m3vek&usp=sharing" },
                16: { nome: "16 Renascença I (parte A)", link: "https://www.google.com/maps/d/edit?mid=1rAwcQRSe44yrG_ZLlQzrXmDvF8-yMfw&usp=sharing" },
                17: { nome: "17 Renascença I (parte B)", link: "https://www.google.com/maps/d/edit?mid=14NQMSbb4rPc0GPbpnaCYJ5OoqaDfdTI&usp=sharing" },
                18: { nome: "18 Renascença I (parte C)", link: "https://www.google.com/maps/d/edit?mid=1IJ26ZGFo4xZ9WmYLXXJhOkRssvn2JXk&usp=sharing" },
                19: { nome: "19 Renascença I (parte D)", link: "https://www.google.com/maps/d/edit?mid=1EIREpoiY8jwoNDiS3TLWOSxiYnIOjSc&usp=sharing" },
                20: { nome: "20 Renascença III", link: "https://www.google.com/maps/d/edit?mid=14yxkw5es33dESFQOouLKK3ds_Wdl_u8&usp=sharing" },
                21: { nome: "21 Loteamento Renascença", link: "https://www.google.com/maps/d/edit?mid=19iTJEvALPSSiz2sk2PZTdq0Gx8rddeY&usp=sharing" },
                22: { nome: "22 Renascença III 3⁰ Etapa", link: "https://www.google.com/maps/d/edit?mid=1gqqoO9XvooYc7Ozm0uZwxoUl_wiTwCM&usp=sharing" },
                23: { nome: "23 Porto Rico II", link: "https://www.google.com/maps/d/edit?mid=1uUPptiKOFxj6jr4gc0ku8teVwuZ2Wjo&usp=sharing" },
                24: { nome: "24 Andaraí", link: "https://www.google.com/maps/d/edit?mid=1xTWvVNf-Wudt0VM7J_8WtYPCtBk8g0g&usp=sharing" },
                25: { nome: "25 Jardim dos Pássaros", link: "https://www.google.com/maps/d/edit?mid=1aw4myYx_sUH76nCOY8bUfZxbf3j-R-I&usp=sharing" },
                26: { nome: "26 Washington", link: "https://www.google.com/maps/d/edit?mid=1xY6AlAJwHOR1VW_ekWPu9M3v2_7npYI&usp=sharing" },
                27: { nome: "27 Vitória Régia", link: "https://www.google.com/maps/d/edit?mid=117QRT5AACiwZ-tNsqOq0sSU3n5mEdLE&usp=sharing" },
                28: { nome: "28 Sertãozinho", link: "https://www.google.com/maps/d/edit?mid=1quh983OQt37GZs5RahXmJyeIfMBOis0&usp=sharing" },
                29: { nome: "29 Canaxuê", link: "https://www.google.com/maps/d/edit?mid=1cxAHyg2XURDmuAVGuLvuq-5U6YBwjyo&usp=sharing" },
                30: { nome: "30 Conj Novo Milênio", link: "https://www.google.com/maps/d/edit?mid=1znUWTVMYYisszT4fKNk_WGloUuxXn7g&usp=sharing" },
                31: { nome: "31 Conj Todos os Santos (parte A)", link: "https://www.google.com/maps/d/edit?mid=1gG8DSODaWwh7gj6fNskS-wnC3KCQ2v0&usp=sharing" },
                32: { nome: "32 Conj Todos os Santos (parte B)", link: "https://www.google.com/maps/d/edit?mid=1B6-oEvxA5OFqWjx76mHH-43f70xCG84&usp=sharing" },
                33: { nome: "33 Deus Proverá", link: "https://www.google.com/maps/d/edit?mid=1mtWN7CxW5O4rAff2zKvBcg61HWs_ZN4&usp=sharing" },
                34: { nome: "34 Loteamento Todos os Santos Lado Direito", link: "https://www.google.com/maps/d/edit?mid=1jLQTSHKy-5v8P2QwKl3lY1ioduf4omg&usp=sharing" },
                35: { nome: "35 Povoado Jumento - Continuação", link: "https://www.google.com/maps/d/edit?mid=1leexMDhfwg5Cc6GuNkcteXCfXVHz-g8&usp=sharing" },
                36: { nome: "36 Pedro Balzi - Vila Nova Esperança", link: "https://www.google.com/maps/d/edit?mid=1rKdGXPe1SY79wpA-MCY8xkmck6_cjuI&usp=sharing" },
                37: { nome: "37 Pedro Balzi - Frente para o Conjunto", link: "https://www.google.com/maps/d/edit?mid=1U3TgYkyojIu1TMzdcsdz5ykKL1xiTpo&usp=sharing" },
                38: { nome: "38 Pedro Balzi - Parte de Cima do Morro", link: "https://www.google.com/maps/d/edit?mid=1hosg_pJqzj_2GK2pgJEI6xl5nX_RnPU&usp=sharing" }
            };

            const todayString = getTodayDayName();

            database.ref("schedules/field").once("value", scheduleSnapshot => {
                const scheduleData = scheduleSnapshot.val() || [];
                const todaySchedule = scheduleData.find(item => item.day === todayString);

                let scheduleHtml = "";
                if (todaySchedule) {
                    scheduleHtml = `
                        <div class="schedule-today" style="background-color: #f0f9ff; border-left: 5px solid #0ea5e9; padding: 16px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); margin-bottom: 24px; font-family: 'Roboto', sans-serif;">
                            
                            <h2 id="titulo-programacao-dia" style="font-size: 1.4rem; font-weight: 500; color: #0c4a6e; margin-top: 0; margin-bottom: 12px; cursor: pointer;" title="Clique para ver a semana completa">
                                Programação de Campo para (${todayString})
                            </h2>
                            
                            <p style="font-size: 1.1rem; margin-bottom: 8px; margin-top: 0; color: #333;"><strong>Local de Saída:</strong> ${todaySchedule.location || 'Não definido'}</p>
                            <p style"font-size: 1.1rem; margin-bottom: 8px; margin-top: 0; color: #333;"><strong>Horário:</strong> ${todaySchedule.time || 'Não definido'}</p>
                            <p style="font-size: 1.1rem; margin: 0; color: #333;"><strong>Dirigente:</strong> ${todaySchedule.leader || 'Não definido'}</p>
                        </div>
                    `;
                } else {
                    scheduleHtml = `
                        <div class="schedule-today" style="background-color: #fffbeb; border-left: 5px solid #facc15; padding: 16px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); margin-bottom: 24px; font-family: 'Roboto', sans-serif;">
                            
                            <h2 id="titulo-programacao-dia" style="font-size: 1.4rem; font-weight: 500; color: #713f12; margin-top: 0; margin-bottom: 12px; cursor: pointer;" title="Clique para ver a semana completa">
                                Programação de Hoje (${todayString})
                            </h2>
                            
                            <p style="font-size: 1.1rem; margin: 0; color: #333;">Nenhuma programação de campo encontrada para hoje.</p>
                        </div>
                    `;
                }
                
                container.innerHTML = scheduleHtml;

                const tituloH2 = document.getElementById("titulo-programacao-dia");
                if (tituloH2) {
                    tituloH2.addEventListener('click', abrirModalProgramacao);
                }


                let gruposParaProcessar = [];
                let locationName = "";
                
                if (todaySchedule && todaySchedule.location && todaySchedule.location.trim() !== "") {
                    locationName = todaySchedule.location.trim();
                    const matchingGroup = grupos.find(g => 
                        g.nome.toLowerCase().includes(locationName.toLowerCase())
                    );
                    
                    if (matchingGroup) {
                        gruposParaProcessar = [matchingGroup];
                    }
                }

                if (gruposParaProcessar.length === 0 && todayString === "Domingo") {
                    gruposParaProcessar = grupos; 
                    locationName = "Todos os grupos"; 
                }

                database.ref("mapas").once("value", mapsSnapshot => {
                    const mapas = mapsSnapshot.val() || {};
                    let hasOpenTerritories = false;

                    gruposParaProcessar.forEach(grupo => {
                        const mapasAbertos = grupo.mapaIds
                            .map(id => ({ id, dados: mapas[id] }))
                            .filter(mapa => mapa.dados && mapa.dados.status === "Status: Em andamento");

                        if (mapasAbertos.length > 0) {
                            hasOpenTerritories = true;
                            
                            const grupoDiv = document.createElement("div");
                            grupoDiv.className = "grupo";
                            grupoDiv.innerHTML = `
                                <div class="grupo-titulo active" onclick="toggleList('${grupo.id}')">${grupo.nome}</div>
                                <div class="grupo-lista card-grid" id="${grupo.id}" style="display: grid;">
                                </div>
                            `;
                            const lista = grupoDiv.querySelector(`#${grupo.id}`);

                            mapasAbertos.forEach(mapa => {
                                const mapaDiv = document.createElement("div");
                                mapaDiv.className = "card mapa-card";

                                let anexoHtml = "";
                                let dataAnexoHtml = ""; 

                                if (mapa.dados.anexoData) {
                                    dataAnexoHtml = `<p style="font-size: 0.9em; color: #555; margin-top: 4px;">Atualizado em: ${formatarData(mapa.dados.anexoData)}</p>`;
                                }

                                if (mapa.dados.anexoURL) {
                                    anexoHtml = `
                                        <div id="anexo-container-${mapa.id}" style="margin-top: 12px;">
                                            <p><strong>Anexo Atual:</strong></p>
                                            <a href="${mapa.dados.anexoURL}" target="_blank">
                                                <img src="${mapa.dados.anexoURL}" alt="Anexo do Mapa ${mapa.id}" 
                                                     style="width: 100%; max-width: 300px; max-height: 300px; height: auto; object-fit: contain; border-radius: 8px; border: 1px solid #ddd; background-color: #f9f9f9;">
                                            </a>
                                            ${dataAnexoHtml} </div>
                                    `;
                                } else {
                                    anexoHtml = `<div id="anexo-container-${mapa.id}"></div>`;
                                }

                                mapaDiv.innerHTML = `
                                    <h3><a href="${mapaInfo[mapa.id].link}" target="_blank">${mapaInfo[mapa.id].nome}</a></h3>
                                    <p><strong>Status:</strong> Em andamento</p>
                                    
                                    <label for="observacao-${mapa.id}"><strong>Observações:</strong></label>
                                    <textarea id="observacao-${mapa.id}" class="observacao-input" placeholder="Digite suas observações">${mapa.dados.observacao || ""}</textarea>
                                    <button class="save-btn" onclick="salvarObservacao(${mapa.id})">Salvar Observação</button>

                                    <hr style="margin: 16px 0; border: 0; border-top: 1px solid #eee;">

                                    ${anexoHtml}

                                    <label for="anexo-input-${mapa.id}" style="display: block; margin-top: 12px; font-weight: bold;">Substituir Anexo (Imagem):</label>
                                    <input type="file" id="anexo-input-${mapa.id}" accept="image/*" style="display: block; margin-top: 4px; width: 100%;">
                                    <button class="save-btn" onclick="salvarAnexo(${mapa.id})" style="margin-top: 8px;">Enviar Anexo</button>
                                    
                                    <div id="upload-status-${mapa.id}" style="font-size: 0.9em; color: #555; margin-top: 4px;"></div>
                                `;
                                lista.appendChild(mapaDiv);
                            });

                            container.appendChild(grupoDiv); 
                        }
                    });

                    let message = "";
                    if (gruposParaProcessar.length === 0) {
                        if (todaySchedule && todaySchedule.location) {
                             message = `Nenhum grupo encontrado para o local de saída de hoje: "${todaySchedule.location}". Verifique a configuração.`;
                        } else if (!todaySchedule && todayString !== "Domingo") {
                            message = "Nenhum local de saída programado para hoje.";
                        }
                    } else if (!hasOpenTerritories) {
                        if (gruposParaProcessar.length > 1) {
                            message = "Não há territórios abertos (em andamento) em nenhum grupo no momento.";
                        } else {
                             message = `O grupo de hoje (${gruposParaProcessar[0].nome}) não possui territórios abertos (em andamento) no momento.`;
                        }
                    }

                    if (message) {
                        const noMapsMessage = document.createElement("p");
                        noMapsMessage.textContent = message;
                        container.appendChild(noMapsMessage);
                    }

                }).catch(error => {
                    console.error("Erro ao carregar territórios:", error);
                    container.innerHTML += "<p>Erro ao carregar territórios: " + error.message + "</p>";
                });
                
            }).catch(error => {
                console.error("Erro ao carregar programação:", error);
                container.innerHTML = "<p>Erro ao carregar programação: " + error.message + "</p>";
            });
        }

        function toggleList(id) {
            const lista = document.getElementById(id);
            const titulo = lista.previousElementSibling;
            if (lista.style.display === "grid") {
                lista.style.display = "none";
                titulo.classList.remove("active");
            } else {
                lista.style.display = "grid";
                titulo.classList.add("active");
            }
        }

        function salvarObservacao(mapaId) {
            const observacao = document.getElementById(`observacao-${mapaId}`).value.trim();
            database.ref(`mapas/${mapaId}/observacao`).set(observacao)
                .then(() => {
                    showToast("Observação salva com sucesso!"); // Usa o toast global
                })
                .catch(error => {
                    console.error("Erro ao salvar observação:", error);
                    showToast("Erro ao salvar observação: " + error.message, true); // Usa o toast global
                });
        }

        function salvarAnexo(mapaId) {
            const input = document.getElementById(`anexo-input-${mapaId}`);
            const file = input.files[0];
            const statusDiv = document.getElementById(`upload-status-${mapaId}`);
            
            if (!file) {
                showToast("Por favor, selecione um arquivo de imagem.", true);
                return;
            }

            statusDiv.textContent = "Enviando imagem...";

            const filePath = `anexos/mapa_${mapaId}/anexo_principal`;
            const storageRef = storage.ref(filePath);
            const task = storageRef.put(file);

            task.on('state_changed', 
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    statusDiv.textContent = 'Enviando... ' + Math.round(progress) + '%';
                }, 
                (error) => {
                    console.error("Erro no upload:", error);
                    statusDiv.textContent = ""; 
                    showToast("Erro ao enviar: " + error.message, true);
                }, 
                () => {
                    task.snapshot.ref.getDownloadURL().then((downloadURL) => {
                        
                        const dataAtual = new Date().toISOString(); 
                        const dataFormatada = formatarData(dataAtual); 

                        database.ref(`mapas/${mapaId}`).update({
                            anexoURL: downloadURL,
                            anexoData: dataAtual 
                        })
                        .then(() => {
                            statusDiv.textContent = ""; 
                            showToast("Anexo salvo com sucesso!");
                            
                            const container = document.getElementById(`anexo-container-${mapaId}`);
                            container.innerHTML = `
                                <p><strong>Anexo Atual:</strong></p>
                                <a href="${downloadURL}" target="_blank">
                                    <img src="${downloadURL}" alt="Anexo do Mapa ${mapa.id}" 
                                            style="width: 100%; max-width: 300px; max-height: 300px; height: auto; object-fit: contain; border-radius: 8px; border: 1px solid #ddd; background-color: #f9f9f9;">
                                </a>
                                <p style="font-size: 0.9em; color: #555; margin-top: 4px;">Atualizado em: ${dataFormatada}</p>
                            `;
                            input.value = "";

                            // *** CHAMA A FUNÇÃO DE NOTIFICAR ***
                            notificarEnvioDeAnexo(mapaId);

                        })
                        .catch((err) => {
                                statusDiv.textContent = "";
                                showToast("Erro ao salvar URL no banco: " + err.message, true);
                        });
                    });
                }
            );
        }

        /**
         * Prepara e chama a Cloud Function de notificação
         */
        function notificarEnvioDeAnexo(mapaId) {
            
            // (Re-declaramos o mapaInfo aqui para esta função ter acesso)
            const mapaInfo = {
                1: { nome: "1 Conjunto São Paulo" }, 2: { nome: "2 Curva São Paulo" }, 3: { nome: "3 Vila Beira Rio" }, 4: { nome: "4 Res Araguaia (parte A)" }, 5: { nome: "5 Res Araguaia (parte B)" }, 6: { nome: "6 Vila Bagda" }, 7: { nome: "7 Vila Firmino (parte A)" }, 8: { nome: "8 Vila Firmino (parte B)" }, 9: { nome: "9 Parque Poty (parte A)" }, 10: { nome: "10 Parque Poty (parte B)" }, 11: { nome: "11 Parque Poty (parte C)" }, 12: { nome: "12 Vila Poty" }, 13: { nome: "13 Sales" }, 14: { nome: "14 Cidade Nova" }, 15: { nome: "15 Porto Rico" }, 16: { nome: "16 Renascença I (parte A)" }, 17: { nome: "17 Renascença I (parte B)" }, 18: { nome: "18 Renascença I (parte C)" }, 19: { nome: "19 Renascença I (parte D)" }, 20: { nome: "20 Renascença III" }, 21: { nome: "21 Loteamento Renascença" }, 22: { nome: "22 Renascença III 3⁰ Etapa" }, 23: { nome: "23 Porto Rico II" }, 24: { nome: "24 Andaraí" }, 25: { nome: "25 Jardim dos Pássaros" }, 26: { nome: "26 Washington" }, 27: { nome: "27 Vitória Régia" }, 28: { nome: "28 Sertãozinho" }, 29: { nome: "29 Canaxuê" }, 30: { nome: "30 Conj Novo Milênio" }, 31: { nome: "31 Conj Todos os Santos (parte A)" }, 32: { nome: "32 Conj Todos os Santos (parte B)" }, 33: { nome: "33 Deus Proverá" }, 34: { nome: "34 Loteamento Todos os Santos Lado Direito" }, 35: { nome: "35 Povoado Jumento - Continuação" }, 36: { nome: "36 Pedro Balzi - Vila Nova Esperança" }, 37: { nome: "37 Pedro Balzi - Frente para o Conjunto" }, 38: { nome: "38 Pedro Balzi - Parte de Cima do Morro" }
            };

            const nomeMapa = mapaInfo[mapaId] ? mapaInfo[mapaId].nome : `Mapa ${mapaId}`;

            const titulo = "Novo Anexo Enviado";
            const corpo = `Um novo anexo foi enviado para o ${nomeMapa}. Abra a app para ver.`;

            showToast("A enviar notificação para todos...");

            // 'functions' é a variável global do firebase.js
            // Verifica se 'functions' foi inicializado com sucesso
            if (!functions) {
                showToast("Erro: Serviço de funções não carregado.", true);
                return;
            }
            
            const enviarNotificacaoPush = functions.httpsCallable('enviarNotificacaoPush');
            
            enviarNotificacaoPush({ titulo: titulo, corpo: corpo })
                .then((result) => {
                    if (result.data.sucesso) {
                        showToast(`Notificação enviada para ${result.data.totalEnviado} dispositivo(s)!`);
                    } else {
                        showToast('Erro ao enviar notificação: ' + result.data.erro, true);
                    }
                })
                .catch((error) => {
                    console.error('Erro ao chamar a Cloud Function:', error);
                    showToast('Erro grave ao enviar notificação.', true);
                });
        }

        // --- FUNÇÕES DO MODAL ---

        function fecharModalProgramacao() {
            const modal = document.getElementById("modal-programacao");
            if (modal) modal.style.display = "none";
        }

        function abrirModalProgramacao() {
            const modal = document.getElementById("modal-programacao");
            const modalConteudo = document.getElementById("modal-conteudo-programacao");
            
            if (!modal || !modalConteudo) return;

            modal.style.display = "block";
            modalConteudo.innerHTML = "<p>Carregando...</p>";

            database.ref("schedules/field").once("value", snapshot => {
                const programacaoSemanal = snapshot.val() || [];
                
                if (programacaoSemanal.length === 0) {
                    modalConteudo.innerHTML = "<p>Nenhuma programação semanal foi configurada.</p>";
                    return;
                }

                let tabelaHtml = `
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                        <thead style="background-color: #f0f0f0;">
                            <tr>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Dia</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Local</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Horário</th>
                                <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Dirigente</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                programacaoSemanal.forEach(item => {
                    tabelaHtml += `
                        <tr>
                            <td style="border: 1px solid #ddd; padding: 8px;"><strong>${item.day}</strong></td>
                            <td style="border: 1px solid #ddd; padding: 8px;">${item.location || ''}</td>
                            <td style="border: 1px solid #ddd; padding: 8px;">${item.time || ''}</td>
                            <td style="border: 1px solid #ddd; padding: 8px;">${item.leader || ''}</td>
                        </tr>
                    `;
                });

                tabelaHtml += `</tbody></table>`;
                modalConteudo.innerHTML = tabelaHtml;

            }).catch(error => {
                console.error("Erro ao buscar programação semanal:", error);
                modalConteudo.innerHTML = "<p>Erro ao carregar a programação. Tente novamente.</p>";
            });
        }
</script>

<script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js') // Certifique-se que o arquivo 'sw.js' existe
          .then(registration => {
            console.log('Service Worker registrado com sucesso.');
          })
          .catch(error => {
            console.error('Falha ao registrar Service Worker:', error);
          });
      });
    }
</script>

<div id="modal-notificacao" class="modal-overlay">
    <div class="modal-content">
        <h2>Ativar Notificações?</h2>
        <p>Gostaria de receber notificações sobre atualizações importantes dos mapas e do aplicativo?</p>
        <div class="modal-buttons">
            <button id="notificacao-nao" class="modal-button">Agora não</button>
            <button id="notificacao-sim" class="modal-button">Sim, ativar</button>
        </div>
    </div>
</div>

<div id="modal-programacao" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6);">
    <div style="background-color: #fefefe; margin: 20% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 600px; border-radius: 10px; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.3);">
        
        <span id="fechar-modal" style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 1;">×</span>
        
        <h2 style="font-size: 1.3rem; font-weight: 500; color: #333; margin-top: 0; margin-bottom: 15px;">Programação Semanal Completa</h2>
        
        <div id="modal-conteudo-programacao" style="max-height: 400px; overflow-y: auto;">
            <p>Carregando...</p>
        </div>
    </div>
</div>

<div id="toast-notification"></div>


</body>
</html>