<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Curva Sﾃ｣o Paulo</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
               body { 
                    margin: 0; 
                    padding: 0; 
                    font-family: Arial, sans-serif; 

                    /* === ADICIONADO === */
                    display: flex;             /* Ativa o layout flexﾃｭvel */
                    flex-direction: column;    /* Empilha os itens (cabeﾃｧalho e mapa) verticalmente */
                    height: 100vh;             /* Faz o corpo ocupar 100% da altura da tela */
                }
                #map { 
                    /* height: 70vh; */  /* <-- REMOVIDO */
                    width: 100%; 

                    /* === ADICIONADO === */
                    flex-grow: 1;       /* Faz o mapa "crescer" e ocupar todo o espaﾃｧo vertical restante */
                }
                        .controls { 
                            padding: 1px; text-align: center; background-color: #f4f4f4; border-bottom: 1px solid #ddd;
                        }
                        button {
                            padding: 8px 15px; margin: 5px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px;
                            }
                        button:hover {
                            background-color: #0056b3; 
                            }
                        /* === CORREﾃﾃグ 1: CSS DO LABEL === */
                            .quadra-label {
                                    background: transparent;
                                    border: none;
                                    box-shadow: none;
                                    color: #333;
                                    font-size: 13px;
                                    /* font-weight: bold; */ 
                                    text-shadow: 0px 0px 3px white, 0px 0px 3px white, 0px 0px 3px white;
                                    text-align: center; 
                                    padding-bottom: 5px; /* Dﾃ｡ um espaﾃｧo geral para o texto girado nﾃ｣o vazar */
                        .status-text {
                            display: inline-block; 
                            
                            /* Combina a rotaﾃｧﾃ｣o E a translaﾃｧﾃ｣o (movimento) na mesma linha.
                            1. Gira -45 graus.
                            2. Move 25px para "baixo" no seu novo eixo diagonal.
                            */
                            transform: rotate(0deg) translateY(0px); 
                            
                            margin-top: 32px; /* Pode deixar uma margem pequena sﾃｳ para garantir o fluxo */
                            font-weight: normal;   

                }
                }
    </style>
</head>
<body>
    <div class="controls">
        <h1>Curva Sﾃ｣o Paulo</h1>
        <p>Clique nas quadras para mudar seu status</p>
        <button id="resetButton">Resetar Todas as Quadras</button>
        <button id="locateButton">桃 Encontrar Minha Localizaﾃｧﾃ｣o</button> 
    </div>
    <div id="map"></div>

    <script>
        // === INﾃ垢IO DA CONFIGURAﾃﾃグ DO FIREBASE ===
        const firebaseConfig = {
            apiKey: "AIzaSyD75RGb3lOiZ0azcSjtP_b9VcZPlHCelJY",
            authDomain: "territorios-3d0bb.firebaseapp.com",
            projectId: "territorios-3d0bb",
            storageBucket: "territorios-3d0bb.firebasestorage.app", 
            messagingSenderId: "712377474662",
            appId: "1:712377474662:web:dfb86ef024b18aa2cb97a7",
            databaseURL: "https://territorios-3d0bb-default-rtdb.firebaseio.com"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const dbRefQuadras = database.ref("curvasaopaulo/quadras");
        // === FIM DA CONFIGURAﾃﾃグ DO FIREBASE ===


        // --- Lﾃ敵ICA DO MAPA (LEAFLET) ---

        //Centralizaﾃｧﾃ｣o do mapa    
        const centroDoMapa = [-5.111024311734093, -42.730347941713596]; 
        const zoomInicial = 18; 

        const map = L.map('map').setView(centroDoMapa, zoomInicial);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        // --- DEFINIﾃﾃグ DAS COORDENADAS ---
        const coords_curva = [
            [-5.111744602892282, -42.732163894156166], // Canto Superior Esquerdo
            [-5.110245329273643, -42.730272946627466], // Canto Superior Direito
            [-5.111291086331554, -42.72938907596957], // Canto Inferior Direito
            [-5.112006041704902, -42.73204604473512]  // Canto Inferior Esquerdo
        ];
       

        // Definiﾃｧﾃ｣o dos estilos de status
        const statusStyles = {
            'Pendente': { color: '#ff0000', fillOpacity: 0, weight: 2 }, // Apenas borda vermelha
            'Em Andamento': { color: '#ffa500', fillColor: '#ffe0b3', fillOpacity: 0.7, weight: 2 },
            'Concluﾃｭdo': { color: '#008000', fillColor: '#ccffcc', fillOpacity: 0.7, weight: 2 }
        };

        // Funﾃｧﾃ｣o para criar uma quadra
        function createQuadra(name, coordinates, initialStatus = 'Pendente') {
            const quadra = L.polygon(coordinates, statusStyles[initialStatus]).addTo(map);
            // O popup (ao clicar) continua mostrando o status
            quadra.bindPopup(`<b>Quadra: ${name}</b><br>Status: ${initialStatus}`);
            
            // ===== CORREﾃﾃグ 2: CRIAﾃﾃグ DO TOOLTIP =====
            // O tooltip (texto fixo) agora mostra o NOME e o STATUS
            const tooltipContent = `<b>${name}</b><br><span class="status-text">${initialStatus}</span>`;; // Nome em negrito + quebra de linha + status
            quadra.bindTooltip(tooltipContent, { 
                permanent: true, 
                direction: 'center', 
                className: 'quadra-label'
            }).openTooltip();
            
            quadra.name = name;
            quadra.status = initialStatus;

            // Adiciona interaﾃｧﾃ｣o de clique
            quadra.on('click', function() {
                if (this.status === 'Pendente') {
                    this.status = 'Em Andamento';
                } else if (this.status === 'Em Andamento') {
                    this.status = 'Concluﾃｭdo';
                } else {
                    this.status = 'Pendente';
                }
                // A cor (estilo) continua mudando
                this.setStyle(statusStyles[this.status]);
                // O popup (ao clicar) continua sendo atualizado
                this.getPopup().setContent(`<b>Quadra: ${this.name}</b><br>Status: ${this.status}`);
                
                // ===== CORREﾃﾃグ 3: ATUALIZAﾃﾃグ DO TOOLTIP NO CLIQUE =====
                // A linha que muda o texto fixo foi RE-ADICIONADA e atualiza com NOME e STATUS
              const newTooltipContent = `<b>${this.name}</b><br><span class="status-text">${this.status}</span>`;
                this.getTooltip().setContent(newTooltipContent);
                
                // O salvamento no Firebase continua igual
                saveQuadraStatus(this.name, this.status);
            });
            return quadra;
        }

        // Array para armazenar todas as quadras
        const quadras = [];

        // Cria as quadras e adiciona ao array
        quadras.push(createQuadra('Curva Sﾃ｣o Paulo', coords_curva));
       
        // Adicione mais quadras aqui...


        // --- FUNCIONALIDADES DE SALVAR E CARREGAR ---

        function saveQuadraStatus(name, status) {
            dbRefQuadras.child(name).set({ status: status })
                .catch(error => console.error("Erro ao salvar status:", error));
        }

        // Sincronizaﾃｧﾃ｣o em Tempo Real
        dbRefQuadras.on('value', (snapshot) => {
            const savedStatuses = snapshot.val() || {}; 
            console.log("Sincronizaﾃｧﾃ｣o: Novos dados recebidos do Firebase:", savedStatuses);

            quadras.forEach(quadra => {
                const savedData = savedStatuses[quadra.name]; 
                let newStatus = 'Pendente'; 

                if (savedData && savedData.status && statusStyles[savedData.status]) {
                    newStatus = savedData.status;
                }
                
                // A lﾃｳgica de status (cor, popup) continua igual
                if (quadra.status !== newStatus) {
                    quadra.status = newStatus;
                    quadra.setStyle(statusStyles[newStatus]);
                    quadra.getPopup().setContent(`<b>Quadra: ${quadra.name}</b><br>Status: ${quadra.status}`);
                    
                    // ===== CORREﾃﾃグ 4: ATUALIZAﾃﾃグ DO TOOLTIP NA SINCRONIZAﾃﾃグ =====
                    // A linha que muda o texto fixo na sincronizaﾃｧﾃ｣o foi RE-ADICIONADA
                   const newTooltipContent = `<b>${quadra.name}</b><br><span class="status-text">${quadra.status}</span>`;;
                    quadra.getTooltip().setContent(newTooltipContent);
                }
            });

        }, (error) => {
            console.error("Erro ao sincronizar com o Firebase:", error);
            alert("Erro de conexﾃ｣o. Nﾃ｣o foi possﾃｭvel sincronizar os status.");
        });

      
        // Botﾃ｣o de Resetar
        document.getElementById('resetButton').addEventListener('click', function() {
            if (confirm('Tem certeza que deseja resetar o status de todas as quadras no FIREBASE para "Pendente"?')) {
                
                dbRefQuadras.remove()
                    .then(() => {
                        // O 'dbRefQuadras.on' vai detectar isso e atualizar o mapa sozinho
                        alert('Todos os status foram resetados para "Pendente" no Firebase.');
                    })
                    .catch(error => {
                        console.error("Erro ao resetar no Firebase:", error);
                        alert("Erro ao resetar status no Firebase.");
                    });
            }
        });


        // --- Lﾃ敵ICA DE GEOLOCALIZAﾃﾃグ (PONTO AZUL) ---
        
        let userDot = null;
        let accuracyCircle = null;

        function onLocationFound(e) {
            const radius = e.accuracy / 2;
            const latlng = e.latlng;

            if (!userDot) {
                userDot = L.circleMarker(latlng, {
                    radius: 8,
                    color: '#007bff',       
                    fillColor: '#007bff',    
                    fillOpacity: 1,
                    weight: 2
                }).addTo(map).bindPopup("Vocﾃｪ estﾃ｡ aqui!");

                accuracyCircle = L.circle(latlng, radius, {
                    color: '#007bff',
                    fillColor: '#007bff',
                    fillOpacity: 0.15,
                    weight: 1
                }).addTo(map);

                map.setView(latlng, 18); 
            } else {
                userDot.setLatLng(latlng);
                accuracyCircle.setLatLng(latlng).setRadius(radius);
            }
        }

        function onLocationError(e) {
            let errorMsg = "Nﾃ｣o foi possﾃｭvel obter sua localizaﾃｧﾃ｣o.\n";
            switch(e.code) {
                case 1: errorMsg += "Permissﾃ｣o negada."; break;
                case 2: errorMsg += "Localizaﾃｧﾃ｣o indisponﾃｭvel."; break;
                case 3: errorMsg += "Tempo esgotado."; break;
                default: errorMsg += "Erro desconhecido.";
            }
            alert(errorMsg);
        }

        document.getElementById('locateButton').addEventListener('click', function() {
            if (!navigator.geolocation) {
                alert("Seu navegador nﾃ｣o suporta geolocalizaﾃｧﾃ｣o.");
                return;
            }

            navigator.geolocation.watchPosition(
                (position) => {
                    const leafletEvent = {
                        latlng: L.latLng(position.coords.latitude, position.coords.longitude),
                        accuracy: position.coords.accuracy
                    };
                    onLocationFound(leafletEvent);
                },
                onLocationError, 
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
            
            this.textContent = "Seguindo localizaﾃｧﾃ｣o...";
            this.disabled = true; 
        });

    </script>
</body>
</html>